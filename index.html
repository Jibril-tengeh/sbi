<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Adhkar Application</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
/* ============ RESET & THEME VARS ============ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#6a1b9a;
  --secondary:#8e24aa;
  --accent:#ef4444;
  --bg:#f8fafc;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --card:#ffffff;
  --card-contrast:#1f2937;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
  --font-arabic-size: 1.35rem;
  --font-translation-size: 1rem;
  --font-transliteration-size: 1rem;
  --overlay: rgba(15,23,42,.5);
  --blur: 10px;
}
html,body{height:100%}
body{
  background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  transition:background .25s,color .25s;
}
.theme-fade{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .35s ease;z-index:9999}
.theme-fade.show{opacity:1}

/* ============ HEADER ============ */
header{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,.12);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.logo{display:flex;gap:10px;align-items:center;font-weight:700;font-size:1.1rem}
.header-icons{display:flex;gap:10px;align-items:center}
.header-icon{
  width:38px;height:38px;border-radius:999px;background:rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s,background .2s;position:relative
}
.header-icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.28)}
.language-text{position:absolute;bottom:-16px;font-size:.68rem;font-weight:600;letter-spacing:.04em}

/* search bar */
#searchBarContainer{width:100%;padding:8px;background:rgba(255,255,255,0.2);display:none}
#searchBar{width:100%;padding:10px 12px;border:none;border-radius:10px;font-size:1rem}

/* top nav */
.topnav{display:flex;gap:8px;margin:10px auto 0;max-width:1000px;padding:0 14px 10px}
.tab-btn{
  flex:1;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;
  background:rgba(255,255,255,.18);color:white;font-weight:600;
  transition:transform .15s,background .15s,opacity .15s
}
.tab-btn.active{background:white;color:#0f172a}
.tab-btn:not(.active):hover{opacity:.9;transform:translateY(-1px)}

/* ============ LAYOUT ============ */
.container{max-width:1000px;margin:12px auto 100px;padding:0 14px}
.section-title{text-align:center;margin:8px 0 16px;color:var(--primary);font-size:1.5rem}

/* ============ LISTS ============ */
.categories-list{list-style:none;max-width:860px;margin:0 auto}
.category-item{
  background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;gap:12px;align-items:center;margin-bottom:10px;
  box-shadow:var(--shadow);transition:border-color .2s,transform .16s,box-shadow .16s;cursor:pointer
}
.category-item:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.category-arrow{color:var(--primary);font-size:1rem}
.category-title{flex:1;font-weight:600}
.category-count{min-width:34px;text-align:center;color:var(--primary);font-weight:700}

/* ============ DUA VIEW ============ */
.back-btn{
  display:inline-flex;gap:8px;align-items:center;margin:6px 0 12px 2px;padding:10px 14px;
  background:var(--primary);color:white;border:none;border-radius:10px;cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.18);transition:transform .15s,opacity .15s
}
.back-btn:hover{transform:translateY(-1px)}
.dua-list{max-width:860px;margin:0 auto 20px}
.dua-item{
  background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow);position:relative;overflow:hidden
}
.dua-header{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:8px
}
.dua-title{font-weight:700;color:var(--primary);font-size:1.05rem}
.dua-arabic{
  font-size:var(--font-arabic-size);line-height:2;direction:rtl;text-align:right;margin:6px 0;
  font-family: var(--arabic-font, "AmiriQuranColored"), "AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","albayan","471btehran","Scheherazade New","Noto Naskh Arabic","Arial";
}
.dua-transliteration{
  font-size:var(--font-transliteration-size);font-style:italic;margin-top:6px;color:#374151
}
.dua-translation{font-size:var(--font-translation-size);margin-top:8px}
.dua-reference{margin-top:8px;color:var(--muted);font-size:.92rem}

/* card actions */
.card-actions{
  margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
}
.action-left{display:flex;gap:8px;align-items:center}
.action-right{display:flex;gap:8px;align-items:center}
.icon-btn{
  border:1px solid var(--border);background:var(--card);color:var(--text);
  padding:8px 10px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
  transition:transform .12s,border-color .15s,box-shadow .15s
}
.icon-btn:hover{transform:translateY(-1px);border-color:var(--primary);box-shadow:0 6px 16px rgba(0,0,0,.10)}
.icon-btn.active{border-color:var(--primary);color:var(--primary)}
.copy-badge{font-size:.82rem;color:var(--muted)}

/* ============ STATES ============ */
.loading,.error,.no-results{text-align:center;color:var(--muted);padding:18px}

/* ============ FLOATING SETTINGS BUTTON ============ */
.fab-settings{
  position:fixed;right:15px;bottom:15px;z-index:30;
  width:56px;height:56px;border-radius:999px;
  backdrop-filter:saturate(140%) blur(6px);
  background:rgba(15,23,42,.3); /* transparent */
  border:1px solid rgba(255,255,255,.25);
  color:#fff;display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.25);
  transition:transform .15s,opacity .15s,background .15s;
}
.fab-settings:hover{transform:translateY(-2px);background:rgba(15,23,42,.38)}

/* ============ SETTINGS PANEL (SHEET) ============ */
.settings-sheet{
  position:fixed;right:0;top:0;height:100%;width:92%;max-width:420px;z-index:50;
  background:rgba(255,255,255,.9);backdrop-filter:blur(12px) saturate(140%);
  box-shadow:-8px 0 28px rgba(15,23,42,.18);
  border-left:1px solid var(--border);
  transform:translateX(105%);transition:transform .25s ease;
  display:flex;flex-direction:column;
}
.settings-sheet.open{transform:translateX(0)}
.sheet-header{
  display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff
}
.sheet-title{font-weight:800;letter-spacing:.2px}
.sheet-close{background:rgba(255,255,255,.2);border:none;border-radius:10px;color:#fff;padding:8px 10px;cursor:pointer}
.sheet-content{padding:14px;overflow:auto}

/* collapsible groups */
.group{border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:var(--shadow);margin-bottom:12px;overflow:hidden}
.group summary{
  list-style:none;cursor:pointer;padding:12px 14px;font-weight:700;color:var(--primary);
  display:flex;align-items:center;justify-content:space-between
}
.group summary::-webkit-details-marker{display:none}
.group .group-body{padding:12px 14px;border-top:1px dashed var(--border);display:grid;gap:12px}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.row label{font-weight:600;color:var(--text);font-size:.98rem}
.switch{
  position:relative;width:46px;height:26px;background:#cbd5e1;border-radius:999px;cursor:pointer;transition:background .2s
}
.switch:before{
  content:"";position:absolute;left:3px;top:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .2s
}
.switch.active{background:var(--primary)}
.switch.active:before{transform:translateX(20px)}
select, input[type="range"], input[type="color"], input[type="number"]{
  width:160px;max-width:60vw;border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--card);color:var(--text)
}
.small-note{font-size:.85rem;color:var(--muted)}

/* theme grid */
.theme-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.theme-swatch{
  height:36px;border-radius:10px;border:1px solid var(--border);cursor:pointer;box-shadow:var(--shadow);transition:transform .12s;
  display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)
}
.theme-swatch:hover{transform:translateY(-2px)}

/* ============ POPUP (MODAL / CONFIRM) ============ */
.modal-overlay{
  position:fixed;inset:0;background:var(--overlay);backdrop-filter:blur(var(--blur));
  display:none;align-items:center;justify-content:center;z-index:60;opacity:0;transition:opacity .2s ease
}
.modal-overlay.show{display:flex;opacity:1}
.modal{
  width:min(92vw,420px);background:rgba(255,255,255,.92);backdrop-filter:blur(10px) saturate(150%);
  border:1px solid var(--border);border-radius:16px;box-shadow:0 18px 44px rgba(0,0,0,.25);
  overflow:hidden;transform:translateY(8px);animation:popin .18s ease forwards
}
@keyframes popin{to{transform:translateY(0)}}
.modal-head{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
.modal-head .icon{font-size:1.2rem}
.modal-title{font-weight:800}
.modal-body{padding:14px 16px;color:var(--text)}
.modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
.btn{
  border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700
}
.btn-primary{background:var(--primary);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.type-success .modal-head{background:rgba(16,185,129,.12)}
.type-error .modal-head{background:rgba(239,68,68,.12)}
.type-info .modal-head{background:rgba(59,130,246,.12)}
.type-confirm .modal-head{background:rgba(234,179,8,.12)}
.type-success .icon{color:#10b981}
.type-error .icon{color:#ef4444}
.type-info .icon{color:#3b82f6}
.type-confirm .icon{color:#eab308}

/* ============ ABOUT (no footer credit) ============ */
.about-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);max-width:860px;margin:0 auto 20px}
.about-card h3{color:var(--primary);margin-bottom:6px}

/* ============ UTIL ============ */
.hidden{display:none!important}
hr.sep{border:none;border-top:1px dashed var(--border);margin:8px 0}
</style>
</head>
<body>
<div class="theme-fade" id="themeFade"></div>

<!-- ======= HEADER ======= -->
<header>
  <div class="logo"><i class="fas fa-star-and-crescent"></i><span>Adhkar</span></div>
  <div class="header-icons">
    <!-- ORDER: search — dark — language -->
    <div class="header-icon" id="searchToggle" title="Search"><i class="fas fa-search"></i></div>
    <div class="header-icon" id="themeToggle" title="Toggle Dark"><i class="fas fa-moon"></i></div>
    <div class="header-icon" id="languageToggle" title="Language">
      <i class="fas fa-language"></i>
      <div class="language-text" id="languageText">EN</div>
    </div>
  </div>
  <!-- Search bar container -->
  <div id="searchBarContainer">
    <input type="text" id="searchBar" placeholder="Search categories or duas...">
  </div>

  <!-- top tabs -->
  <div class="topnav">
    <button class="tab-btn active" id="tabCategories"><i class="fa-solid fa-list"></i>&nbsp;Categories</button>
    <button class="tab-btn" id="tabFavorites"><i class="fa-solid fa-heart"></i>&nbsp;Favorites</button>
    <button class="tab-btn" id="tabAbout"><i class="fa-solid fa-circle-info"></i>&nbsp;About</button>
  </div>
</header>

<!-- ======= MAIN ======= -->
<div class="container">
  <h1 class="section-title">Categories</h1>

  <!-- CATEGORIES VIEW -->
  <ul id="categoriesList" class="categories-list">
    <li class="loading">Loading categories...</li>
  </ul>

  <!-- DUA VIEW -->
  <div id="categoryDetails" style="display:none;">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> <span id="backLabel">Back</span></button>
    <div id="duaContainer" class="dua-list"></div>
  </div>

  <!-- FAVORITES VIEW -->
  <div id="favoritesView" class="dua-list hidden"></div>

  <!-- ABOUT VIEW -->
  <div id="aboutView" class="hidden">
    <div class="about-card">
      <h3>About</h3>
      <p>This Adhkar app helps you browse categories and duas in multiple languages, customize display, themes and more — fully offline-capable when hosted with your JSON files.</p>
      <hr class="sep"/>
      <p><strong>Developed by Jibril SBI TENGEH</strong></p>
    </div>
  </div>
</div>

<!-- ======= FLOATING SETTINGS BUTTON ======= -->
<button class="fab-settings" id="openSettings" title="Settings">
  <i class="fa-solid fa-sliders"></i>
</button>

<!-- ======= SETTINGS SHEET ======= -->
<aside class="settings-sheet" id="settingsSheet" aria-hidden="true">
  <div class="sheet-header">
    <div class="sheet-title"><i class="fa-solid fa-sliders"></i> &nbsp;<span id="settingsTitle">Settings</span></div>
    <button class="sheet-close" id="closeSettings"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="sheet-content">

    <!-- DISPLAY (dropdown) -->
    <details class="group" id="grpDisplay" open>
      <summary><span><i class="fa-solid fa-eye"></i> &nbsp;<span id="displayTitle">Display</span></span><i class="fa-solid fa-chevron-down"></i></summary>
      <div class="group-body">
        <div class="row">
          <label id="lblShowTranslation">Show Translations</label>
          <div class="switch" id="swShowTranslation" role="switch" aria-checked="true" tabindex="0"></div>
        </div>
        <div class="row">
          <label id="lblShowTransliteration">Show Transliteration</label>
          <div class="switch" id="swShowTransliteration" role="switch" aria-checked="true" tabindex="0"></div>
        </div>
        <div class="row">
          <label id="lblArabicSize">Arabic size</label>
          <input id="rangeArabic" type="range" min="1.0" max="2.4" step="0.05">
        </div>
        <div class="row">
          <label id="lblTranslationSize">Translation size</label>
          <input id="rangeTranslation" type="range" min="0.8" max="1.6" step="0.05">
        </div>
        <div class="row">
          <label id="lblTranslitSize">Transliteration size</label>
          <input id="rangeTranslit" type="range" min="0.8" max="1.6" step="0.05">
        </div>
        <div class="row">
          <label id="lblArabicFont">Arabic Font</label>
          <select id="selectArabicFont">
            <option value='"AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","albayan","471btehran","Scheherazade New","Noto Naskh Arabic","Arial"'>Default (Amiri/Scheherazade)</option>
            <option value='"Amiri-BoldSlanted","amiri-bold","AmiriQuranColored","albayan","471btehran","Arial"'>Amiri-BoldSlanted</option>
            <option value='"albayan","AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","Arial"'>albayan</option>
            <option value='"471btehran","AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","Arial"'>471btehran</option>
            <option value='"AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","albayan","471btehran","Arial"'>AmiriQuranColored</option>
            <option value='"amiri-bold","Amiri-BoldSlanted","AmiriQuranColored","albayan","471btehran","Arial"'>amiri-bold</option>
          </select>
        </div>
        <div class="small-note" id="noteFonts">These font names must exist on the device to render.</div>
      </div>
    </details>

    <!-- THEME -->
    <details class="group" id="grpTheme">
      <summary><span><i class="fa-solid fa-palette"></i> &nbsp;<span id="themeTitle">Theme</span></span><i class="fa-solid fa-chevron-down"></i></summary>
      <div class="group-body">
        <button class="icon-btn" id="btnOpenThemePicker"><i class="fa-solid fa-swatchbook"></i><span id="openThemePickerLabel">Open Themes</span></button>
        <div id="themePicker" class="theme-grid hidden"></div>

        <div class="row"><label id="lblDarkMode">Dark mode</label><div class="switch" id="swDarkMode" role="switch" aria-checked="false" tabindex="0"></div></div>
        <div class="row"><label id="lblSystemDark">Use system dark</label><div class="switch" id="swSystemDark" role="switch" aria-checked="true" tabindex="0"></div></div>

        <hr class="sep">
        <div class="row"><strong id="lblCustomThemeTitle">Create your theme</strong></div>
        <div class="row"><label>Primary</label><input type="color" id="cPrimary" value="#6a1b9a"></div>
        <div class="row"><label>Secondary</label><input type="color" id="cSecondary" value="#8e24aa"></div>
        <div class="row"><label>Accent</label><input type="color" id="cAccent" value="#ef4444"></div>
        <div class="row"><label>Background</label><input type="color" id="cBg" value="#f8fafc"></div>
        <div class="row"><label>Text</label><input type="color" id="cText" value="#0f172a"></div>
        <div class="row"><label>Card</label><input type="color" id="cCard" value="#ffffff"></div>
        <div class="row">
          <button class="btn btn-ghost" id="btnPreviewTheme"><i class="fa-solid fa-eye"></i>&nbsp;<span id="previewLabel">Preview</span></button>
          <button class="btn btn-primary" id="btnSaveTheme"><i class="fa-solid fa-floppy-disk"></i>&nbsp;<span id="saveThemeLabel">Save</span></button>
        </div>
        <div class="small-note" id="noteThemeSave">Your theme is saved locally.</div>
      </div>
    </details>

    <!-- LANGUAGE -->
    <details class="group" id="grpLanguage">
      <summary><span><i class="fa-solid fa-globe"></i> &nbsp;<span id="languageTitle">Language</span></span><i class="fa-solid fa-chevron-down"></i></summary>
      <div class="group-body">
        <div class="row">
          <label id="lblLangPick">Choose language</label>
          <select id="selectLanguage">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ru">Русский</option>
            <option value="zh">中文</option>
            <option value="ha">Hausa</option>
          </select>
        </div>
        <div class="small-note" id="noteLang">Settings will follow your chosen language.</div>
      </div>
    </details>

    <!-- ABOUT -->
    <details class="group" id="grpAbout">
      <summary><span><i class="fa-solid fa-circle-info"></i> &nbsp;<span id="aboutTitle">About</span></span><i class="fa-solid fa-chevron-down"></i></summary>
      <div class="group-body">
        <div><strong>Adhkar</strong> — customizable dhikr & dua app.</div>
        <div>Version: 1.0</div>
        <hr class="sep">
        <div><strong>Developed by Jibril SBI TENGEH</strong></div>
      </div>
    </details>

  </div>
</aside>

<!-- ======= POPUP (UNIFIED) ======= -->
<div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal type-info" id="modal">
    <div class="modal-head">
      <div class="icon" id="modalIcon">ℹ️</div>
      <div class="modal-title" id="modalTitle">Info</div>
    </div>
    <div class="modal-body" id="modalMessage">Message...</div>
    <div class="modal-actions" id="modalActions">
      <button class="btn btn-ghost" id="btnCancel" style="display:none">Cancel</button>
      <button class="btn btn-primary" id="btnOk">OK</button>
    </div>
  </div>
</div>

<script>
/* ================== STATE ================== */
let currentLanguage = 'en';
let categoriesData = [];
let duasData = [];
let showTransliterations = true;
let showTranslations = true;
let fontArabic = getComputedStyle(document.documentElement).getPropertyValue('--arabic-font') || '';
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
let savedItems = JSON.parse(localStorage.getItem('savedDuas')||'[]');
let useSystemDark = true;
let darkMode = false;
let currentThemeKey = localStorage.getItem('themeKey') || 'theme1';
let customTheme = JSON.parse(localStorage.getItem('customTheme')||'{}');

const els = {
  categoriesList: document.getElementById('categoriesList'),
  categoryDetails: document.getElementById('categoryDetails'),
  duaContainer: document.getElementById('duaContainer'),
  backBtn: document.getElementById('backBtn'),
  backLabel: document.getElementById('backLabel'),
  languageText: document.getElementById('languageText'),
  themeToggle: document.getElementById('themeToggle'),
  searchToggle: document.getElementById('searchToggle'),
  searchBarContainer: document.getElementById('searchBarContainer'),
  searchBar: document.getElementById('searchBar'),
  tabCategories: document.getElementById('tabCategories'),
  tabFavorites: document.getElementById('tabFavorites'),
  tabAbout: document.getElementById('tabAbout'),
  favoritesView: document.getElementById('favoritesView'),
  aboutView: document.getElementById('aboutView'),
  openSettings: document.getElementById('openSettings'),
  settingsSheet: document.getElementById('settingsSheet'),
  closeSettings: document.getElementById('closeSettings'),
  // display toggles
  swShowTranslation: document.getElementById('swShowTranslation'),
  swShowTransliteration: document.getElementById('swShowTransliteration'),
  rangeArabic: document.getElementById('rangeArabic'),
  rangeTranslation: document.getElementById('rangeTranslation'),
  rangeTranslit: document.getElementById('rangeTranslit'),
  selectArabicFont: document.getElementById('selectArabicFont'),
  // theme
  swDarkMode: document.getElementById('swDarkMode'),
  swSystemDark: document.getElementById('swSystemDark'),
  btnOpenThemePicker: document.getElementById('btnOpenThemePicker'),
  themePicker: document.getElementById('themePicker'),
  cPrimary: document.getElementById('cPrimary'),
  cSecondary: document.getElementById('cSecondary'),
  cAccent: document.getElementById('cAccent'),
  cBg: document.getElementById('cBg'),
  cText: document.getElementById('cText'),
  cCard: document.getElementById('cCard'),
  btnPreviewTheme: document.getElementById('btnPreviewTheme'),
  btnSaveTheme: document.getElementById('btnSaveTheme'),
  // language
  selectLanguage: document.getElementById('selectLanguage'),
  // modal
  modalOverlay: document.getElementById('modalOverlay'),
  modal: document.getElementById('modal'),
  modalIcon: document.getElementById('modalIcon'),
  modalTitle: document.getElementById('modalTitle'),
  modalMessage: document.getElementById('modalMessage'),
  btnCancel: document.getElementById('btnCancel'),
  btnOk: document.getElementById('btnOk'),
};

/* ================== THEMES ================== */
const THEMES = {
  theme1:{primary:"#6a1b9a",secondary:"#8e24aa",accent:"#ef4444",bg:"#f8fafc",text:"#0f172a",card:"#ffffff"},
  theme2:{primary:"#16a34a",secondary:"#0e9f6e",accent:"#f05252",bg:"#f9fafb",text:"#111827",card:"#ffffff"},
  theme3:{primary:"#2563eb",secondary:"#4f46e5",accent:"#ef4444",bg:"#f1f5f9",text:"#0f172a",card:"#ffffff"},
  theme4:{primary:"#0ea5e9",secondary:"#06b6d4",accent:"#f59e0b",bg:"#f8fafc",text:"#0f172a",card:"#ffffff"},
  theme5:{primary:"#ea580c",secondary:"#f59e0b",accent:"#10b981",bg:"#fff7ed",text:"#0f172a",card:"#ffffff"},
  theme6:{primary:"#dc2626",secondary:"#ef4444",accent:"#16a34a",bg:"#fef2f2",text:"#0f172a",card:"#ffffff"},
  theme7:{primary:"#059669",secondary:"#10b981",accent:"#ef4444",bg:"#f0fdf4",text:"#052e16",card:"#ffffff"},
  theme8:{primary:"#7c3aed",secondary:"#6d28d9",accent:"#f43f5e",bg:"#f3e8ff",text:"#1e1b4b",card:"#ffffff"},
  theme9:{primary:"#111827",secondary:"#374151",accent:"#f59e0b",bg:"#f3f4f6",text:"#111827",card:"#ffffff"},
  theme10:{primary:"#0f766e",secondary:"#115e59",accent:"#ef4444",bg:"#ecfeff",text:"#022c22",card:"#ffffff"},
  theme11:{primary:"#4338ca",secondary:"#3730a3",accent:"#fb7185",bg:"#eef2ff",text:"#111827",card:"#ffffff"},
  theme12:{primary:"#3f6212",secondary:"#4d7c0f",accent:"#f97316",bg:"#f7fee7",text:"#052e16",card:"#ffffff"},
  theme13:{primary:"#155e75",secondary:"#0e7490",accent:"#f472b6",bg:"#ecfeff",text:"#0f172a",card:"#ffffff"},
  theme14:{primary:"#b91c1c",secondary:"#7f1d1d",accent:"#22c55e",bg:"#fff1f2",text:"#111827",card:"#ffffff"},
  theme15:{primary:"#dc2626",secondary:"#f97316",accent:"#22d3ee",bg:"#fff7ed",text:"#0f172a",card:"#ffffff"},
  theme16:{primary:"#1d4ed8",secondary:"#1e40af",accent:"#22c55e",bg:"#eff6ff",text:"#0f172a",card:"#ffffff"},
  theme17:{primary:"#d946ef",secondary:"#a21caf",accent:"#22c55e",bg:"#fdf4ff",text:"#3b0764",card:"#ffffff"},
  theme18:{primary:"#fb7185",secondary:"#f43f5e",accent:"#10b981",bg:"#fff1f2",text:"#881337",card:"#ffffff"},
  theme19:{primary:"#ea580c",secondary:"#c2410c",accent:"#22c55e",bg:"#fff7ed",text:"#7c2d12",card:"#ffffff"},
  theme20:{primary:"#0284c7",secondary:"#0369a1",accent:"#f97316",bg:"#f0f9ff",text:"#0c4a6e",card:"#ffffff"},
  theme21:{primary:"#0ea5e9",secondary:"#2563eb",accent:"#0ea5e9",bg:"#0b1220",text:"#e5e7eb",card:"#111827"},
  theme22:{primary:"#22c55e",secondary:"#16a34a",accent:"#84cc16",bg:"#0b1220",text:"#e5e7eb",card:"#111827"},
  theme23:{primary:"#f59e0b",secondary:"#f97316",accent:"#ef4444",bg:"#0b1220",text:"#e5e7eb",card:"#111827"},
  theme24:{primary:"#a78bfa",secondary:"#8b5cf6",accent:"#f472b6",bg:"#0b1220",text:"#e5e7eb",card:"#111827"},
  theme25:{primary:"#14b8a6",secondary:"#06b6d4",accent:"#f43f5e",bg:"#0b1220",text:"#e5e7eb",card:"#111827"},
};

/* ================== APPLY THEME ================== */
function applyTheme(vars){
  const r = document.documentElement.style;
  r.setProperty('--primary', vars.primary);
  r.setProperty('--secondary', vars.secondary);
  r.setProperty('--accent', vars.accent);
  r.setProperty('--bg', vars.bg);
  r.setProperty('--text', vars.text);
  r.setProperty('--card', vars.card);
  // border/muted auto
  const border = darkMode ? 'rgba(255,255,255,.12)' : '#e2e8f0';
  const muted = darkMode ? '#94a3b8' : '#64748b';
  r.setProperty('--border', border);
  r.setProperty('--muted', muted);
  // update header gradient instantly
  showThemeFlash();
}

function showThemeFlash(){
  const f = document.getElementById('themeFade');
  f.classList.add('show');
  setTimeout(()=>f.classList.remove('show'),220);
}

function applyThemeKey(key){
  currentThemeKey = key;
  const v = (key==='custom' && Object.keys(customTheme).length)? customTheme : THEMES[key] || THEMES.theme1;
  applyTheme(v);
  localStorage.setItem('themeKey', key);
}

/* ================== DARK MODE ================== */
function setDarkMode(on){
  darkMode = on;
  document.body.classList.toggle('dark', on);
  if(on){
    document.documentElement.style.setProperty('--bg', '#0b1220');
    document.documentElement.style.setProperty('--text', '#e5e7eb');
    document.documentElement.style.setProperty('--card', '#111827');
    document.documentElement.style.setProperty('--border', 'rgba(255,255,255,.12)');
    document.documentElement.style.setProperty('--muted', '#94a3b8');
  }else{
    // restore theme colors
    applyThemeKey(currentThemeKey);
  }
  localStorage.setItem('darkMode', JSON.stringify(darkMode));
  els.themeToggle.querySelector('i').className = on ? 'fas fa-sun' : 'fas fa-moon';
}

/* ================== POPUP SYSTEM ================== */
function showPopup({type='info', title='Info', message='', confirm=false, autocloseMs=0}){
  return new Promise(resolve=>{
    const overlay = els.modalOverlay;
    const modal = els.modal;
    modal.className = 'modal type-' + (confirm?'confirm':type);
    els.modalTitle.textContent = title;
    els.modalMessage.textContent = message;
    let icon = 'ℹ️';
    if(type==='success') icon='✅';
    if(type==='error') icon='⚠️';
    if(type==='info') icon='ℹ️';
    if(confirm) icon='❓';
    els.modalIcon.textContent = icon;

    // buttons
    els.btnCancel.style.display = confirm ? 'inline-block' : 'none';
    overlay.classList.add('show');
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');

    let timer;
    if(!confirm && autocloseMs>0){
      timer = setTimeout(()=>{ close('ok'); }, autocloseMs);
    }

    function close(result){
      clearTimeout(timer);
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      setTimeout(()=>{ overlay.style.display='none'; resolve(result==='ok'); },160);
    }
    els.btnOk.onclick = ()=>close('ok');
    els.btnCancel.onclick = ()=>close('cancel');
    overlay.onclick = (e)=>{ if(e.target===overlay && !confirm) close('ok'); };
  });
}

/* ================== FAVORITES ================== */
function isFav(id){ return favorites.includes(id); }
function toggleFav(id){
  if(isFav(id)) favorites = favorites.filter(x=>x!==id);
  else favorites.push(id);
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderDuas(); renderFavorites();
}

/* ================== SAVE (LOCAL) ================== */
function isSaved(id){ return savedItems.includes(id); }
function toggleSaved(id){
  if(isSaved(id)) savedItems = savedItems.filter(x=>x!==id);
  else savedItems.push(id);
  localStorage.setItem('savedDuas', JSON.stringify(savedItems));
  renderDuas(); renderFavorites();
}

/* ================== SHARE/COPY ================== */
async function shareDua(dua){
  const textParts = [];
  if(dua.arabic) textParts.push(dua.arabic);
  if(showTransliterations && dua.transliteration) textParts.push(dua.transliteration);
  if(showTranslations && dua.translation) textParts.push(dua.translation);
  const text = textParts.join('\n\n');

  try{
    if(navigator.share){
      await navigator.share({title:'Dua', text});
      showPopup({type:'success',title:'Shared',message:'Dua shared successfully.', autocloseMs:2000});
    }else{
      await navigator.clipboard.writeText(text);
      showPopup({type:'success',title:'Copied',message:'Dua copied to clipboard.', autocloseMs:2000});
    }
  }catch(e){
    await navigator.clipboard.writeText(text);
    showPopup({type:'success',title:'Copied',message:'Dua copied to clipboard.', autocloseMs:2000});
  }
}

/* ================== FETCHING ================== */
async function loadCategories(){
  try{
    els.categoriesList.innerHTML = '<li class="loading">Loading categories...</li>';
    const res = await fetch(`categories/${currentLanguage}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    categoriesData = await res.json();
    renderCategories();
  }catch(err){
    console.error('Categories error:', err);
    els.categoriesList.innerHTML = '<li class="error">Failed to load categories.</li>';
  }
}

function renderCategories(filter=''){
  const ul = els.categoriesList; ul.innerHTML = '';
  let filtered = categoriesData;
  if(filter){
    filtered = categoriesData.filter(cat=>cat.title.toLowerCase().includes(filter.toLowerCase()));
  }
  if(!filtered.length){ ul.innerHTML = '<li class="no-results">No categories available</li>'; return; }
  filtered.forEach((cat, idx)=>{
    const li = document.createElement('li'); li.className = 'category-item';
    li.innerHTML = `
      <div class="category-arrow"><i class="fas fa-chevron-right"></i></div>
      <div class="category-title">${cat.title}</div>
      <div class="category-count">${idx+1}</div>
    `;
    li.addEventListener('click', ()=>loadCategoryDuas(idx+1, cat.title));
    ul.appendChild(li);
  });
}

async function loadCategoryDuas(categoryId, categoryName){
  try{
    els.categoryDetails.style.display = 'block';
    els.categoriesList.style.display = 'none';
    document.querySelector('.section-title').textContent = categoryName;
    els.duaContainer.innerHTML = '<div class="loading">Loading duas...</div>';
    const res = await fetch(`duas/categories_${categoryId}/${currentLanguage}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    duasData = await res.json();
    renderDuas();
  }catch(err){
    console.error('Duas error:', err);
    els.duaContainer.innerHTML = '<div class="error">Failed to load duas.</div>';
  }
}

function duaCard(dua){
  const id = dua.id || `${dua.category}_${dua.index || Math.random().toString(36).slice(2)}`;
  const fav = isFav(id);
  const saved = isSaved(id);
  return `
    <div class="dua-item" data-id="${id}">
      <div class="dua-header">
        <div class="dua-title">${dua.title || ''}</div>
      </div>
      ${dua.arabic ? `<div class="dua-arabic" style="font-family: var(--arabic-font, ${document.documentElement.style.getPropertyValue('--arabic-font') || '"AmiriQuranColored","Amiri-BoldSlanted","amiri-bold","albayan","471btehran","Scheherazade New","Noto Naskh Arabic","Arial"'} );">${dua.arabic}</div>` : ''}
      ${showTransliterations && dua.transliteration ? `<div class="dua-transliteration">${dua.transliteration}</div>` : ''}
      ${showTranslations && dua.translation ? `<div class="dua-translation">${dua.translation}</div>` : ''}
      ${dua.reference ? `<div class="dua-reference">${dua.reference}</div>` : ''}

      <div class="card-actions">
        <div class="action-left">
          <button class="icon-btn btn-share" title="Share"><i class="fa-solid fa-share-nodes"></i><span>Share</span></button>
          <button class="icon-btn btn-copy" title="Copy"><i class="fa-solid fa-copy"></i><span>Copy</span></button>
        </div>
        <div class="action-right">
          <button class="icon-btn btn-fav ${fav?'active':''}" title="Favorite"><i class="fa-solid fa-heart"></i><span>${fav?'Favorited':'Favorite'}</span></button>
          <button class="icon-btn btn-save ${saved?'active':''}" title="Save"><i class="fa-solid fa-bookmark"></i><span>${saved?'Saved':'Save'}</span></button>
        </div>
      </div>
    </div>
  `;
}

function renderDuas(filter=''){
  const container = els.duaContainer; container.innerHTML = '';
  let filtered = duasData;
  if(filter){
    filtered = duasData.filter(dua=> (dua.translation && dua.translation.toLowerCase().includes(filter.toLowerCase())) || (dua.arabic && dua.arabic.includes(filter)));
  }
  if(!filtered.length){ container.innerHTML = '<div class="no-results">No duas available</div>'; return; }
  const frag = document.createDocumentFragment();
  filtered.forEach(dua=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = duaCard(dua);
    const node = wrapper.firstElementChild;

    // attach actions
    node.querySelector('.btn-share').addEventListener('click', ()=>shareDua(dua));
    node.querySelector('.btn-copy').addEventListener('click', async ()=>{
      const parts = [];
      if(dua.arabic) parts.push(dua.arabic);
      if(showTransliterations && dua.transliteration) parts.push(dua.transliteration);
      if(showTranslations && dua.translation) parts.push(dua.translation);
      await navigator.clipboard.writeText(parts.join('\n\n'));
      showPopup({type:'success',title:'Copied',message:'Dua copied to clipboard.', autocloseMs:2000});
    });
    node.querySelector('.btn-fav').addEventListener('click', ()=>{
      const id = node.getAttribute('data-id');
      toggleFav(id);
    });
    node.querySelector('.btn-save').addEventListener('click', ()=>{
      const id = node.getAttribute('data-id');
      toggleSaved(id);
      showPopup({type:'success',title:'Saved',message:'Saved locally on this device.', autocloseMs:2000});
    });

    frag.appendChild(node);
  });
  container.appendChild(frag);
}

function renderFavorites(){
  const view = els.favoritesView; view.innerHTML = '';
  if(!favorites.length){
    view.innerHTML = `<div class="no-results">No favorites yet.</div>`;
    return;
  }
  // Build from current duasData + best-effort lookup
  const items = [];
  const pushFrom = (arr)=>arr.forEach(dua=>{
    const id = dua.id || `${dua.category}_${dua.index || ''}`;
    if(favorites.includes(id)){
      items.push(dua);
    }
  });
  pushFrom(duasData);
  // Render
  if(!items.length){
    view.innerHTML = `<div class="no-results">Your favorites will appear here.</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  items.forEach(dua=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = duaCard(dua);
    const node = wrapper.firstElementChild;
    node.querySelector('.btn-share').addEventListener('click', ()=>shareDua(dua));
    node.querySelector('.btn-copy').addEventListener('click', async ()=>{
      const parts = [];
      if(dua.arabic) parts.push(dua.arabic);
      if(showTransliterations && dua.transliteration) parts.push(dua.transliteration);
      if(showTranslations && dua.translation) parts.push(dua.translation);
      await navigator.clipboard.writeText(parts.join('\n\n'));
      showPopup({type:'success',title:'Copied',message:'Dua copied to clipboard.', autocloseMs:2000});
    });
    node.querySelector('.btn-fav').addEventListener('click', ()=>{
      const id = node.getAttribute('data-id');
      toggleFav(id);
    });
    node.querySelector('.btn-save').addEventListener('click', ()=>{
      const id = node.getAttribute('data-id');
      toggleSaved(id);
      showPopup({type:'success',title:'Saved',message:'Saved locally on this device.', autocloseMs:2000});
    });
    frag.appendChild(node);
  });
  view.appendChild(frag);
}

/* ================== UI EVENTS ================== */
/* header toggles */
document.getElementById('languageToggle').addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  localStorage.setItem('language', currentLanguage);
  // refresh lists
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  document.querySelector('.section-title').textContent = 'Categories';
  loadCategories();
});

els.backBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  document.querySelector('.section-title').textContent = 'Categories';
});

// Dark icon toggler (quick)
els.themeToggle.addEventListener('click', ()=>{
  const on = !(darkMode);
  setDarkMode(on);
});

// Search toggle
els.searchToggle.addEventListener('click', ()=>{
  els.searchBarContainer.style.display = els.searchBarContainer.style.display === 'none' ? 'block' : 'none';
  els.searchBar.focus();
});

// Search input filter (contextual)
els.searchBar.addEventListener('input', ()=>{
  if(els.categoryDetails.style.display === 'block'){
    renderDuas(els.searchBar.value);
  } else {
    renderCategories(els.searchBar.value);
  }
});

/* top tabs */
function setTab(btn){
  [els.tabCategories, els.tabFavorites, els.tabAbout].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const isCat = btn===els.tabCategories;
  const isFav = btn===els.tabFavorites;
  const isAbout = btn===els.tabAbout;
  document.querySelector('.section-title').textContent = isCat ? 'Categories' : isFav ? 'Favorites' : 'About';
  els.categoriesList.classList.toggle('hidden', !isCat);
  els.categoryDetails.style.display = 'none';
  els.favoritesView.classList.toggle('hidden', !isFav);
  els.aboutView.classList.toggle('hidden', !isAbout);
  if(isFav) renderFavorites();
}
els.tabCategories.addEventListener('click', ()=>setTab(els.tabCategories));
els.tabFavorites.addEventListener('click', ()=>setTab(els.tabFavorites));
els.tabAbout.addEventListener('click', ()=>setTab(els.tabAbout));

/* settings sheet */
els.openSettings.addEventListener('click', ()=>els.settingsSheet.classList.add('open'));
els.closeSettings.addEventListener('click', ()=>els.settingsSheet.classList.remove('open'));

/* switches helpers */
function bindSwitch(el, initial, onChange){
  function set(v){
    el.classList.toggle('active', v);
    el.setAttribute('aria-checked', v?'true':'false');
    onChange(v);
  }
  el.addEventListener('click', ()=>set(!el.classList.contains('active')));
  el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); set(!el.classList.contains('active'));} });
  set(initial);
}

/* Display toggles */
bindSwitch(els.swShowTranslation, true, (v)=>{
  showTranslations = v; localStorage.setItem('showTranslations', JSON.stringify(v)); renderDuas();
});
bindSwitch(els.swShowTransliteration, true, (v)=>{
  showTransliterations = v; localStorage.setItem('showTransliterations', JSON.stringify(v)); renderDuas();
});

/* Font sizes + font family */
function applyFontSizes(){
  document.documentElement.style.setProperty('--font-arabic-size', `${parseFloat(els.rangeArabic.value)}rem`);
  document.documentElement.style.setProperty('--font-translation-size', `${parseFloat(els.rangeTranslation.value)}rem`);
  document.documentElement.style.setProperty('--font-transliteration-size', `${parseFloat(els.rangeTranslit.value)}rem`);
  localStorage.setItem('sizes', JSON.stringify({
    a:els.rangeArabic.value,t:els.rangeTranslation.value,l:els.rangeTranslit.value
  }));
}
[els.rangeArabic, els.rangeTranslation, els.rangeTranslit].forEach(r=>r.addEventListener('input', applyFontSizes));

els.selectArabicFont.addEventListener('change', ()=>{
  const value = els.selectArabicFont.value;
  document.documentElement.style.setProperty('--arabic-font', value);
  localStorage.setItem('arabicFont', value);
  renderDuas();
});

/* Theme switches */
bindSwitch(els.swDarkMode, JSON.parse(localStorage.getItem('darkMode')||'false'), (v)=>setDarkMode(v));
bindSwitch(els.swSystemDark, JSON.parse(localStorage.getItem('useSystemDark')||'true'), (v)=>{
  useSystemDark = v; localStorage.setItem('useSystemDark', JSON.stringify(v));
  if(v){
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    setDarkMode(mq.matches);
  }
});

/* System dark listener */
const mqDark = window.matchMedia('(prefers-color-scheme: dark)');
mqDark.addEventListener('change', (e)=>{ if(useSystemDark) setDarkMode(e.matches); });

/* Theme picker grid */
function buildThemeGrid(){
  const grid = els.themePicker; grid.innerHTML='';
  Object.keys(THEMES).forEach((k,i)=>{
    const t = THEMES[k];
    const sw = document.createElement('div');
    sw.className = 'theme-swatch';
    sw.style.background = `linear-gradient(135deg, ${t.primary}, ${t.secondary})`;
    sw.textContent = i+1;
    sw.title = `Theme ${i+1}`;
    sw.addEventListener('click', ()=>{ applyThemeKey(k); showPopup({type:'success',title:'Theme',message:`Theme ${i+1} applied.`, autocloseMs:2000}); });
    grid.appendChild(sw);
  });
  const swc = document.createElement('div');
  swc.className='theme-swatch';
  swc.style.background='linear-gradient(135deg,#111827,#334155)';
  swc.textContent='C';
  swc.title='Custom';
  swc.addEventListener('click', ()=>{ applyThemeKey('custom'); showPopup({type:'success',title:'Theme',message:'Custom theme applied.', autocloseMs:2000}); });
  grid.appendChild(swc);
}
els.btnOpenThemePicker.addEventListener('click', ()=>{
  els.themePicker.classList.toggle('hidden');
  if(!els.themePicker.dataset.built){ buildThemeGrid(); els.themePicker.dataset.built='1'; }
});

/* Preview/save custom theme */
els.btnPreviewTheme.addEventListener('click', ()=>{
  const v = {
    primary: els.cPrimary.value, secondary: els.cSecondary.value, accent: els.cAccent.value,
    bg: els.cBg.value, text: els.cText.value, card: els.cCard.value
  };
  applyTheme(v);
});
els.btnSaveTheme.addEventListener('click', ()=>{
  customTheme = {
    primary: els.cPrimary.value, secondary: els.cSecondary.value, accent: els.cAccent.value,
    bg: els.cBg.value, text: els.cText.value, card: els.cCard.value
  };
  localStorage.setItem('customTheme', JSON.stringify(customTheme));
  applyThemeKey('custom');
  showPopup({type:'success',title:'Saved',message:'Custom theme saved.', autocloseMs:2000});
});

/* Language picker (in settings) */
els.selectLanguage.addEventListener('change', ()=>{
  currentLanguage = els.selectLanguage.value;
  els.languageText.textContent = currentLanguage.toUpperCase();
  localStorage.setItem('language', currentLanguage);
  // reload categories
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  document.querySelector('.section-title').textContent = 'Categories';
  loadCategories();
});

/* ================== INIT ================== */
function restoreSettings(){
  const lang = localStorage.getItem('language');
  if(lang){ currentLanguage = lang; }
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.selectLanguage.value = currentLanguage;

  const st = JSON.parse(localStorage.getItem('showTranslations')||'true');
  const sl = JSON.parse(localStorage.getItem('showTransliterations')||'true');
  showTranslations = st; showTransliterations = sl;
  // reflect switches
  els.swShowTranslation.classList.toggle('active', st);
  els.swShowTranslation.setAttribute('aria-checked', st?'true':'false');
  els.swShowTransliteration.classList.toggle('active', sl);
  els.swShowTransliteration.setAttribute('aria-checked', sl?'true':'false');

  const sizes = JSON.parse(localStorage.getItem('sizes')||'{}');
  els.rangeArabic.value = sizes.a || 1.35;
  els.rangeTranslation.value = sizes.t || 1.0;
  els.rangeTranslit.value = sizes.l || 1.0;
  applyFontSizes();

  const af = localStorage.getItem('arabicFont');
  if(af){ document.documentElement.style.setProperty('--arabic-font', af); els.selectArabicFont.value = af; }

  useSystemDark = JSON.parse(localStorage.getItem('useSystemDark')||'true');
  els.swSystemDark.classList.toggle('active', useSystemDark);
  els.swSystemDark.setAttribute('aria-checked', useSystemDark?'true':'false');

  const dm = JSON.parse(localStorage.getItem('darkMode')||'false');
  setDarkMode(dm);
  els.swDarkMode.classList.toggle('active', dm);
  els.swDarkMode.setAttribute('aria-checked', dm?'true':'false');

  // theme
  applyThemeKey(currentThemeKey);
}

function i18nApply(){
  // Minimal: update labels based on language if needed. (Keep English defaults)
  const dict = {
    en:{Back:'Back',Settings:'Settings',Display:'Display',Theme:'Theme',Language:'Language',About:'About',
        'Show Translations':'Show Translations','Show Transliteration':'Show Transliteration',
        'Arabic size':'Arabic size','Translation size':'Translation size','Transliteration size':'Transliteration size',
        'Arabic Font':'Arabic Font','Open Themes':'Open Themes','Dark mode':'Dark mode','Use system dark':'Use system dark',
        'Create your theme':'Create your theme','Preview':'Preview','Save':'Save','Choose language':'Choose language',
        'Settings will follow your chosen language.':'Settings will follow your chosen language.'},
    fr:{Back:'Retour',Settings:'Paramètres',Display:'Affichage',Theme:'Thème',Language:'Langue',About:'À propos',
        'Show Translations':'Afficher les traductions','Show Transliteration':'Afficher la translittération',
        'Arabic size':'Taille arabe','Translation size':'Taille traduction','Transliteration size':'Taille translittération',
        'Arabic Font':'Police arabe','Open Themes':'Ouvrir les thèmes','Dark mode':'Mode sombre','Use system dark':'Suivre le système',
        'Create your theme':'Créer votre thème','Preview':'Aperçu','Save':'Enregistrer','Choose language':'Choisir la langue',
        'Settings will follow your chosen language.':'Les paramètres suivent votre langue.'},
    ru:{Back:'Назад',Settings:'Настройки',Display:'Отображение',Theme:'Тема',Language:'Язык',About:'О приложении',
        'Show Translations':'Показывать перевод','Show Transliteration':'Показывать транслитерацию',
        'Arabic size':'Размер арабского','Translation size':'Размер перевода','Transliteration size':'Размер транслитерации',
        'Arabic Font':'Арабский шрифт','Open Themes':'Открыть темы','Dark mode':'Тёмный режим','Use system dark':'Системная тема',
        'Create your theme':'Создать свою тему','Preview':'Предпросмотр','Save':'Сохранить','Choose language':'Выбрать язык',
        'Settings will follow your chosen language.':'Настройки зависят от языка.'},
    zh:{Back:'返回',Settings:'设置',Display:'显示',Theme:'主题',Language:'语言',About:'关于',
        'Show Translations':'显示翻译','Show Transliteration':'显示转写',
        'Arabic size':'阿拉伯文字大小','Translation size':'翻译文字大小','Transliteration size':'转写文字大小',
        'Arabic Font':'阿拉伯字体','Open Themes':'打开主题','Dark mode':'深色模式','Use system dark':'跟随系统',
        'Create your theme':'创建自定义主题','Preview':'预览','Save':'保存','Choose language':'选择语言',
        'Settings will follow your chosen language.':'设置将遵循所选语言。'},
    ha:{Back:'Koma baya',Settings:'Saituna',Display:'Nuni',Theme:'Jigo',Language:'Harshe',About:'Game da',
        'Show Translations':'Nuna fassara','Show Transliteration':'Nuna rubutun canji',
        'Arabic size':'Girman Larabci','Translation size':'Girman fassara','Transliteration size':'Girman rubutun canji',
        'Arabic Font':'Rubutun Larabci','Open Themes':'Buɗe jigogi','Dark mode':'Yanayin duhu','Use system dark':'Bi tsarin',
        'Create your theme':'Ƙirƙiri jigonka','Preview':'Dubawa','Save':'Ajiye','Choose language':'Zaɓi harshe',
        'Settings will follow your chosen language.':'Saituna za su bi harshenka.'},
  }[currentLanguage]||null;

  if(!dict) return;
  els.backLabel.textContent = dict.Back;
  document.getElementById('settingsTitle').textContent = dict.Settings;
  document.getElementById('displayTitle').textContent = dict.Display;
  document.getElementById('themeTitle').textContent = dict.Theme;
  document.getElementById('languageTitle').textContent = dict.Language;
  document.getElementById('aboutTitle').textContent = dict.About;
  document.getElementById('lblShowTranslation').textContent = dict['Show Translations'];
  document.getElementById('lblShowTransliteration').textContent = dict['Show Transliteration'];
  document.getElementById('lblArabicSize').textContent = dict['Arabic size'];
  document.getElementById('lblTranslationSize').textContent = dict['Translation size'];
  document.getElementById('lblTranslitSize').textContent = dict['Transliteration size'];
  document.getElementById('lblArabicFont').textContent = dict['Arabic Font'];
  document.getElementById('openThemePickerLabel').textContent = dict['Open Themes'];
  document.getElementById('lblDarkMode').textContent = dict['Dark mode'];
  document.getElementById('lblSystemDark').textContent = dict['Use system dark'];
  document.getElementById('lblCustomThemeTitle').textContent = dict['Create your theme'];
  document.getElementById('previewLabel').textContent = dict['Preview'];
  document.getElementById('saveThemeLabel').textContent = dict['Save'];
  document.getElementById('lblLangPick').textContent = dict['Choose language'];
  document.getElementById('noteLang').textContent = dict['Settings will follow your chosen language.'];
}

function init(){
  restoreSettings();
  i18nApply();
  loadCategories();
}
init();
</script>
</body>
</html>
