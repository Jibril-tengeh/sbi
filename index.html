<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Adhkar Application</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ============ RESET & THEME VARS ============ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#16a34a;
  --secondary:#0e9f6e;
  --accent:#f05252;
  --bg:#f9fafb;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --card:#ffffff;
  --card-contrast:#1f2937;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
  --font-arabic-size: 1.35rem;
  --font-translation-size: 1rem;
  --font-transliteration-size: 1rem;

  --arabic-font: "Amiri", serif;
}
@font-face{font-family:"Amiri-BoldSlanted";src:local("Amiri Bold Slanted"),local("Amiri-BoldSlanted")}
@font-face{font-family:"albayan";src:local("Al Bayan"),local("albayan")}
@font-face{font-family:"471btehran";src:local("B Tehran"),local("471btehran")}
@font-face{font-family:"AmiriQuranColored";src:local("Amiri Quran Colored"),local("AmiriQuranColored")}
@font-face{font-family:"amiri-bold";src:local("Amiri Bold"),local("amiri-bold")}

html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";transition:background .25s,color .25s}
.theme-fade{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .35s ease;z-index:9999}
.theme-fade.show{opacity:1}

/* ============ HEADER ============ */
header{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,.12);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.logo{display:flex;gap:10px;align-items:center;font-weight:700;font-size:1.1rem}
.header-icons{display:flex;gap:10px;align-items:center}
.header-icon{
  width:38px;height:38px;border-radius:999px;background:rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s,background .2s;position:relative
}
.header-icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.28)}
.language-text{position:absolute;bottom:-16px;font-size:.68rem;font-weight:600;letter-spacing:.04em}

/* Search bar */
#searchBarContainer{
  width:100%;padding:8px;background:rgba(255,255,255,0.2);
  display:none; /* hidden until toggled */
}
#searchBar{
  width:100%;padding:8px 12px;border:none;border-radius:8px;font-size:1rem;
}

/* ============ MAIN ============ */
.container{max-width:1000px;margin:16px auto 110px;padding:0 14px}
.section-title-wrap{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.section-title{margin:6px 0 6px;color:var(--primary);font-size:1.5rem}
.section-actions{display:flex;gap:8px;align-items:center}
.pill-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--text);box-shadow:var(--shadow);font-size:.9rem;cursor:pointer}
.pill-btn.active{border-color:var(--primary);color:var(--primary)}

/* ============ LISTS ============ */
.categories-list{list-style:none;max-width:860px;margin:0 auto}
.category-item{
  background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;gap:12px;align-items:center;margin-bottom:10px;
  box-shadow:var(--shadow);transition:border-color .2s,transform .16s,box-shadow .16s;cursor:pointer
}
.category-item:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.category-arrow{color:var(--primary);font-size:1rem}
.category-title{flex:1;font-weight:600}
.category-count{min-width:34px;text-align:center;color:var(--primary);font-weight:700}

/* ============ DUA VIEW ============ */
.back-btn{
  display:inline-flex;gap:8px;align-items:center;margin:6px 0 12px 2px;padding:10px 14px;
  background:var(--primary);color:white;border:none;border-radius:10px;cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.18);transition:transform .15s,opacity .15s
}
.back-btn:hover{transform:translateY(-1px)}
.dua-list{max-width:860px;margin:0 auto 20px}
.dua-item{
  background:var(--card);border-left:5px solid var(--primary);border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:var(--shadow);position:relative
}
.dua-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;color:var(--muted);font-size:.9rem}
.dua-arabic{
  font-size:var(--font-arabic-size);line-height:2;direction:rtl;text-align:right;margin-bottom:6px;
  font-family:var(--arabic-font);
}
.dua-transliteration{font-size:var(--font-transliteration-size);font-style:italic;margin-top:4px;color:#374151}
.dua-translation{font-size:var(--font-translation-size);margin-top:6px}
.dua-reference{margin-top:6px;color:var(--muted);font-size:.92rem}
.dua-actions{
  display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;padding-top:8px;border-top:1px dashed var(--border)
}
.icon-btn{
  display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer;transition:transform .12s,border-color .12s,background .12s;
}
.icon-btn:hover{transform:translateY(-1px);border-color:var(--primary)}
.icon-btn .fa{font-size:1rem}
.icon-btn.fav.active{color:#b91c1c;border-color:#b91c1c}

/* ============ STATES ============ */
.loading,.error,.no-results{text-align:center;color:var(--muted);padding:18px}

/* ============ FLOATING SETTINGS BUTTON ============ */
#settingsFab{
  position:fixed;right:15px;bottom:15px;width:56px;height:56px;border-radius:50%;
  background:rgba(255,255,255,.25);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.4);
  display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:40;
  box-shadow:0 8px 24px rgba(0,0,0,.2);color:#111
}
#settingsFab:hover{transform:translateY(-1px)}
#settingsFab i{font-size:1.2rem}

/* ============ SETTINGS PANEL (SHEET) ============ */
.sheet{
  position:fixed;inset:auto 0 0 0;height:78vh;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;
  box-shadow:0 -10px 30px rgba(0,0,0,.2);transform:translateY(100%);transition:transform .28s ease;z-index:50;border:1px solid var(--border)
}
.sheet.show{transform:translateY(0)}
.sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.sheet-title{font-weight:700}
.sheet-close{border:none;background:transparent;font-size:1.2rem;cursor:pointer}
.sheet-content{padding:10px 16px 18px;overflow:auto;height:calc(78vh - 54px)}

.section{border:1px solid var(--border);border-radius:12px;background:var(--card);margin-bottom:12px;box-shadow:var(--shadow);overflow:hidden}
.section summary{
  list-style:none;cursor:pointer;padding:12px 14px;font-weight:700;display:flex;align-items:center;justify-content:space-between
}
.section summary::-webkit-details-marker{display:none}
.section .section-body{padding:10px 14px 12px;border-top:1px dashed var(--border)}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
.row label{font-size:.95rem}
.row .controls{display:flex;align-items:center;gap:8px}
.switch{
  position:relative;width:48px;height:26px;border-radius:999px;background:#e5e7eb;cursor:pointer;flex-shrink:0;border:1px solid var(--border)
}
.switch input{display:none}
.switch::after{
  content:"";position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:white;box-shadow:var(--shadow);transition:left .18s
}
.switch input:checked + .thumb{left:24px}
.switch.on{background:#22c55e}
.thumb{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:white;box-shadow:var(--shadow);transition:left .18s}

/* range + selects */
input[type="range"]{width:160px}
select, input[type="text"], input[type="color"]{
  padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)
}

/* Theme grid */
.theme-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;margin-top:8px}
.theme-card{
  height:42px;border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.75rem
}
.theme-card .swatch{width:100%;height:100%;border-radius:9px}

/* Modal (About) */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.28);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:60
}
.modal.show{display:flex}
.modal-card{max-width:520px;width:92%;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
.modal-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-body{padding:14px}

/* Toasts */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:90px;background:var(--card);color:var(--text);
  border:1px solid var(--border);box-shadow:var(--shadow);
  padding:10px 14px;border-radius:12px;z-index:80;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s
}
.toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px)}
.toast.success{border-color:#16a34a}
.toast.info{border-color:#2563eb}
.toast.warn{border-color:#f59e0b}
.toast.error{border-color:#ef4444}

/* Footer actions (sticky) */
.footer-actions{
  position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:8px 12px;z-index:30
}

/* Dark theme helper when user toggles “moon/sun” only switches palette index */
body.dark .logo i,
body.dark .category-arrow{color:#fbbf24}
</style>
</head>
<body>
<div class="theme-fade" id="themeFade"></div>

<!-- ======= HEADER ======= -->
<header>
  <div class="logo"><i class="fas fa-star-and-crescent"></i><span>Adhkar</span></div>
  <div class="header-icons">
    <!-- Order: search — dark mode — languages -->
    <div class="header-icon" id="searchToggle" title="Search">
      <i class="fas fa-search"></i>
    </div>
    <div class="header-icon" id="themeToggle" title="Toggle Sun/Moon"><i class="fas fa-moon"></i></div>
    <div class="header-icon" id="languageToggle" title="Language">
      <i class="fas fa-language"></i>
      <div class="language-text" id="languageText">EN</div>
    </div>
  </div>
  <!-- Search bar container -->
  <div id="searchBarContainer">
    <input type="text" id="searchBar" placeholder="Search categories or duas...">
  </div>
</header>

<!-- ======= MAIN ======= -->
<div class="container">
  <div class="section-title-wrap">
    <h1 class="section-title">Categories</h1>
    <div class="section-actions">
      <button class="pill-btn" id="favoritesViewBtn" title="View favorites"><i class="fa fa-heart"></i> <span class="fav-count">0</span></button>
      <button class="pill-btn" id="aboutBtn"><i class="fa fa-circle-info"></i> About</button>
    </div>
  </div>

  <ul id="categoriesList" class="categories-list">
    <li class="loading">Loading categories...</li>
  </ul>

  <div id="categoryDetails" style="display:none;">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
    <div id="duaContainer" class="dua-list"></div>
  </div>
</div>

<!-- ======= FLOATING SETTINGS BUTTON ======= -->
<button id="settingsFab" aria-label="Settings"><i class="fa fa-sliders"></i></button>

<!-- ======= SETTINGS SHEET ======= -->
<div class="sheet" id="settingsSheet" aria-hidden="true">
  <div class="sheet-header">
    <div class="sheet-title" id="settingsTitle">Settings</div>
    <button class="sheet-close" id="closeSettings"><i class="fa fa-xmark"></i></button>
  </div>
  <div class="sheet-content">
    <!-- Display (Collapsible default OPEN) -->
    <details class="section" id="displaySection" open>
      <summary>
        <span id="displayTitle">Display</span>
        <i class="fa fa-chevron-down"></i>
      </summary>
      <div class="section-body">
        <div class="row">
          <label for="toggleTranslations">Show Translations</label>
          <div class="controls">
            <div class="switch" id="toggleTranslationsSwitch">
              <input type="checkbox" id="toggleTranslations">
              <span class="thumb"></span>
            </div>
          </div>
        </div>
        <div class="row">
          <label for="toggleTransliterations">Show Transliterations</label>
          <div class="controls">
            <div class="switch" id="toggleTransliterationsSwitch">
              <input type="checkbox" id="toggleTransliterations">
              <span class="thumb"></span>
            </div>
          </div>
        </div>

        <div class="row">
          <label>Arabic size</label>
          <div class="controls">
            <input type="range" id="arabicSize" min="18" max="44" value="22">
            <span id="arabicSizeVal">22px</span>
          </div>
        </div>
        <div class="row">
          <label>Translation size</label>
          <div class="controls">
            <input type="range" id="translationSize" min="12" max="28" value="16">
            <span id="translationSizeVal">16px</span>
          </div>
        </div>
        <div class="row">
          <label>Transliteration size</label>
          <div class="controls">
            <input type="range" id="transliterationSize" min="12" max="28" value="16">
            <span id="transliterationSizeVal">16px</span>
          </div>
        </div>

        <div class="row">
          <label>Arabic Font</label>
          <div class="controls">
            <select id="arabicFont">
              <option value="Amiri-BoldSlanted">Amiri-BoldSlanted</option>
              <option value="albayan">albayan</option>
              <option value="471btehran">471btehran</option>
              <option value="AmiriQuranColored">AmiriQuranColored</option>
              <option value="amiri-bold">amiri-bold</option>
              <option value="Amiri">Amiri (system)</option>
            </select>
          </div>
        </div>
      </div>
    </details>

    <!-- Theme -->
    <details class="section" id="themeSection">
      <summary>
        <span id="themeTitle">Theme</span>
        <i class="fa fa-chevron-down"></i>
      </summary>
      <div class="section-body">
        <button class="pill-btn" id="openThemeGridBtn"><i class="fa fa-palette"></i> Choose Theme</button>
        <div id="themeGrid" class="theme-grid" style="display:none;"></div>

        <div class="row" style="margin-top:10px">
          <label>Create your theme</label>
        </div>
        <div class="row">
          <label>Primary</label>
          <input type="color" id="cPrimary" value="#16a34a">
          <label>Secondary</label>
          <input type="color" id="cSecondary" value="#0e9f6e">
        </div>
        <div class="row">
          <label>Accent</label>
          <input type="color" id="cAccent" value="#f05252">
          <label>BG</label>
          <input type="color" id="cBg" value="#f9fafb">
        </div>
        <div class="row">
          <label>Text</label>
          <input type="color" id="cText" value="#111827">
          <label>Card</label>
          <input type="color" id="cCard" value="#ffffff">
        </div>
        <div class="row">
          <label>Border</label>
          <input type="color" id="cBorder" value="#e5e7eb">
        </div>
        <button class="pill-btn" id="applyCustomTheme"><i class="fa fa-check"></i> Apply Custom Theme</button>
      </div>
    </details>

    <!-- Language -->
    <details class="section" id="languageSection">
      <summary>
        <span id="languageTitle">Language</span>
        <i class="fa fa-chevron-down"></i>
      </summary>
      <div class="section-body">
        <div class="row">
          <label>Current</label>
          <div class="controls">
            <span id="currentLangLabel">EN</span>
          </div>
        </div>
        <div class="row">
          <label>Switch</label>
          <div class="controls">
            <button class="pill-btn" id="cycleLangBtn"><i class="fa fa-language"></i> Cycle</button>
          </div>
        </div>
      </div>
    </details>

    <!-- About -->
    <details class="section" id="aboutSection">
      <summary>
        <span id="aboutTitle">About</span>
        <i class="fa fa-chevron-down"></i>
      </summary>
      <div class="section-body">
        <p style="margin-bottom:6px">Adhkar & Dua Application</p>
        <p style="color:var(--muted);font-size:.95rem">Developed by <strong>Jibril SBI TENGEH</strong>.</p>
      </div>
    </details>
  </div>
</div>

<!-- ======= ABOUT MODAL (optional quick access) ======= -->
<div class="modal" id="aboutModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <strong>About</strong>
      <button class="sheet-close" id="closeAbout"><i class="fa fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <p>This app presents categories and duas from JSON files, with offline caching, favorites, sharing, and rich settings.</p>
      <p style="margin-top:8px;color:var(--muted)">Developed by <strong>Jibril SBI TENGEH</strong>.</p>
    </div>
  </div>
</div>

<!-- ======= TOAST ======= -->
<div class="toast" id="toast"></div>

<!-- ======= FOOTER (sticky actions bar; not “developed by”) ======= -->
<div class="footer-actions" id="footerBar">
  <div style="display:flex;gap:8px;align-items:center;">
    <button class="pill-btn" id="homeBtn"><i class="fa fa-house"></i> Home</button>
    <button class="pill-btn" id="favOnlyBtn"><i class="fa fa-heart"></i> Favorites</button>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <span style="color:var(--muted);font-size:.9rem" id="statusText">Ready</span>
  </div>
</div>

<script>
/* ================== CONFIG (GitHub raw) ================== */
const GITHUB_USER  = "jibril-tengeh";
const GITHUB_REPO  = "sbi";
const GITHUB_BRANCH= "main"; // change if your default branch is different
const GITHUB_BASE  = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;

/* ================== STATE ================== */
let currentLanguage = localStorage.getItem('lang') || 'en';
let categoriesData = [];
let duasData = [];      // current category
let favorites = JSON.parse(localStorage.getItem('favorites')||'{}'); // {duaId:boolean}
let showTransliterations = JSON.parse(localStorage.getItem('showTransliterations')||'true');
let showTranslations = JSON.parse(localStorage.getItem('showTranslations')||'true');

let fontArabic = localStorage.getItem('fontArabic') || 'Amiri';
let fontSizeArabic = parseInt(localStorage.getItem('fontSizeArabic')||'22',10);
let fontSizeTranslation = parseInt(localStorage.getItem('fontSizeTranslation')||'16',10);
let fontSizeTransliteration = parseInt(localStorage.getItem('fontSizeTransliteration')||'16',10);

let themeIndex = parseInt(localStorage.getItem('themeIndex')||'0',10); // 0..24
let customTheme = JSON.parse(localStorage.getItem('customTheme')||'null');

let viewingFavorites = false;

/* ================== UI ELEMENTS ================== */
const els = {
  categoriesList: document.getElementById('categoriesList'),
  categoryDetails: document.getElementById('categoryDetails'),
  duaContainer: document.getElementById('duaContainer'),
  backBtn: document.getElementById('backBtn'),
  languageText: document.getElementById('languageText'),
  themeToggle: document.getElementById('themeToggle'),
  searchToggle: document.getElementById('searchToggle'),
  searchBarContainer: document.getElementById('searchBarContainer'),
  searchBar: document.getElementById('searchBar'),
  sectionTitle: document.querySelector('.section-title'),
  favoritesViewBtn: document.getElementById('favoritesViewBtn'),
  favOnlyBtn: document.getElementById('favOnlyBtn'),
  homeBtn: document.getElementById('homeBtn'),
  aboutBtn: document.getElementById('aboutBtn'),
  aboutModal: document.getElementById('aboutModal'),
  closeAbout: document.getElementById('closeAbout'),
  settingsFab: document.getElementById('settingsFab'),
  settingsSheet: document.getElementById('settingsSheet'),
  closeSettings: document.getElementById('closeSettings'),
  currentLangLabel: document.getElementById('currentLangLabel'),
  cycleLangBtn: document.getElementById('cycleLangBtn'),
  toast: document.getElementById('toast'),
  statusText: document.getElementById('statusText'),

  // Settings controls
  toggleTranslations: document.getElementById('toggleTranslations'),
  toggleTranslationsSwitch: document.getElementById('toggleTranslationsSwitch'),
  toggleTransliterations: document.getElementById('toggleTransliterations'),
  toggleTransliterationsSwitch: document.getElementById('toggleTransliterationsSwitch'),
  arabicSize: document.getElementById('arabicSize'),
  arabicSizeVal: document.getElementById('arabicSizeVal'),
  translationSize: document.getElementById('translationSize'),
  translationSizeVal: document.getElementById('translationSizeVal'),
  transliterationSize: document.getElementById('transliterationSize'),
  transliterationSizeVal: document.getElementById('transliterationSizeVal'),
  arabicFont: document.getElementById('arabicFont'),
  openThemeGridBtn: document.getElementById('openThemeGridBtn'),
  themeGrid: document.getElementById('themeGrid'),
  applyCustomTheme: document.getElementById('applyCustomTheme'),

  cPrimary: document.getElementById('cPrimary'),
  cSecondary: document.getElementById('cSecondary'),
  cAccent: document.getElementById('cAccent'),
  cBg: document.getElementById('cBg'),
  cText: document.getElementById('cText'),
  cCard: document.getElementById('cCard'),
  cBorder: document.getElementById('cBorder'),
};

/* ================== THEMES (25 presets) ================== */
const THEMES = [
  {name:"Emerald", primary:"#16a34a",secondary:"#0e9f6e",accent:"#f05252",bg:"#f9fafb",text:"#111827",border:"#e5e7eb",card:"#ffffff"},
  {name:"Ocean", primary:"#0284c7",secondary:"#0ea5e9",accent:"#f97316",bg:"#f1f5f9",text:"#0f172a",border:"#e2e8f0",card:"#ffffff"},
  {name:"Rose", primary:"#e11d48",secondary:"#fb7185",accent:"#22c55e",bg:"#fff1f2",text:"#111827",border:"#fecdd3",card:"#ffffff"},
  {name:"Grape", primary:"#7c3aed",secondary:"#a78bfa",accent:"#06b6d4",bg:"#f5f3ff",text:"#111827",border:"#ddd6fe",card:"#ffffff"},
  {name:"Sunset", primary:"#f59e0b",secondary:"#f97316",accent:"#10b981",bg:"#fff7ed",text:"#111827",border:"#fed7aa",card:"#ffffff"},
  {name:"Forest", primary:"#166534",secondary:"#16a34a",accent:"#f59e0b",bg:"#ecfdf5",text:"#052e16",border:"#bbf7d0",card:"#ffffff"},
  {name:"Slate", primary:"#334155",secondary:"#64748b",accent:"#ef4444",bg:"#f1f5f9",text:"#0f172a",border:"#e2e8f0",card:"#ffffff"},
  {name:"Sky", primary:"#0ea5e9",secondary:"#38bdf8",accent:"#6366f1",bg:"#e0f2fe",text:"#0c4a6e",border:"#bae6fd",card:"#ffffff"},
  {name:"Mint", primary:"#10b981",secondary:"#34d399",accent:"#f43f5e",bg:"#ecfeff",text:"#052e16",border:"#a7f3d0",card:"#ffffff"},
  {name:"Cocoa", primary:"#7c3f00",secondary:"#a16207",accent:"#ef4444",bg:"#fff7ed",text:"#3f2d1c",border:"#f4d6b0",card:"#ffffff"},
  {name:"Royal", primary:"#1d4ed8",secondary:"#6366f1",accent:"#22c55e",bg:"#eff6ff",text:"#0b1a51",border:"#bfdbfe",card:"#ffffff"},
  {name:"Crimson", primary:"#dc2626",secondary:"#ef4444",accent:"#06b6d4",bg:"#fef2f2",text:"#111827",border:"#fecaca",card:"#ffffff"},
  {name:"Lime", primary:"#84cc16",secondary:"#65a30d",accent:"#0ea5e9",bg:"#f7fee7",text:"#1a2e05",border:"#d9f99d",card:"#ffffff"},
  {name:"Aubergine", primary:"#581c87",secondary:"#7e22ce",accent:"#22c55e",bg:"#faf5ff",text:"#2e1065",border:"#e9d5ff",card:"#ffffff"},
  {name:"Gold", primary:"#d97706",secondary:"#f59e0b",accent:"#10b981",bg:"#fffbeb",text:"#111827",border:"#fde68a",card:"#ffffff"},
  {name:"Teal", primary:"#0f766e",secondary:"#14b8a6",accent:"#f59e0b",bg:"#ecfeff",text:"#0f172a",border:"#99f6e4",card:"#ffffff"},
  {name:"Lagoon", primary:"#0891b2",secondary:"#06b6d4",accent:"#a78bfa",bg:"#ecfeff",text:"#0e7490",border:"#67e8f9",card:"#ffffff"},
  {name:"Steel", primary:"#1f2937",secondary:"#4b5563",accent:"#f59e0b",bg:"#f3f4f6",text:"#111827",border:"#e5e7eb",card:"#ffffff"},
  {name:"WarmGrey", primary:"#6b7280",secondary:"#9ca3af",accent:"#f97316",bg:"#f9fafb",text:"#111827",border:"#e5e7eb",card:"#ffffff"},
  {name:"CyanPop", primary:"#06b6d4",secondary:"#22d3ee",accent:"#ef4444",bg:"#ecfeff",text:"#0e7490",border:"#a5f3fc",card:"#ffffff"},
  {name:"Dark", primary:"#14b8a6",secondary:"#0ea5e9",accent:"#ef4444",bg:"#0b1020",text:"#f4f4f5",border:"#1f2937",card:"#0f172a"},
  {name:"Midnight", primary:"#6366f1",secondary:"#7c3aed",accent:"#22c55e",bg:"#0f172a",text:"#e5e7eb",border:"#1f2937",card:"#111827"},
  {name:"Charcoal", primary:"#94a3b8",secondary:"#64748b",accent:"#22c55e",bg:"#0b1220",text:"#e2e8f0",border:"#1e293b",card:"#111827"},
  {name:"Olive", primary:"#84cc16",secondary:"#65a30d",accent:"#22c55e",bg:"#111827",text:"#e5e7eb",border:"#334155",card:"#0b1220"},
  {name:"Ink", primary:"#22c55e",secondary:"#0ea5e9",accent:"#f97316",bg:"#0b0f19",text:"#e5e7eb",border:"#1f2937",card:"#111827"},
];

/* ================== HELPERS ================== */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

function toast(msg,type="info",ms=2000){
  els.toast.textContent = msg;
  els.toast.className = `toast ${type} show`;
  setTimeout(()=>{els.toast.classList.remove('show')}, ms);
}

function setStatus(msg){ els.statusText.textContent = msg; }

function applyTheme(theme){
  const r = document.documentElement;
  r.style.setProperty('--primary', theme.primary);
  r.style.setProperty('--secondary', theme.secondary);
  r.style.setProperty('--accent', theme.accent);
  r.style.setProperty('--bg', theme.bg);
  r.style.setProperty('--text', theme.text);
  r.style.setProperty('--border', theme.border);
  r.style.setProperty('--card', theme.card);

  // toggle dark class hint (used for small styling touches)
  const darkBg = tinyColor(theme.bg).isDark();
  document.body.classList.toggle('dark', darkBg);
}

function tinyColor(hex){
  // mini color helper to detect luminance
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  const luma = (0.2126*r + 0.7152*g + 0.0722*b)/255;
  return {
    isDark: ()=> luma < 0.5
  }
}

function savePrefs(){
  localStorage.setItem('lang', currentLanguage);
  localStorage.setItem('showTranslations', JSON.stringify(showTranslations));
  localStorage.setItem('showTransliterations', JSON.stringify(showTransliterations));
  localStorage.setItem('fontArabic', fontArabic);
  localStorage.setItem('fontSizeArabic', fontSizeArabic);
  localStorage.setItem('fontSizeTranslation', fontSizeTranslation);
  localStorage.setItem('fontSizeTransliteration', fontSizeTransliteration);
  localStorage.setItem('themeIndex', themeIndex);
  if(customTheme) localStorage.setItem('customTheme', JSON.stringify(customTheme));
}

function updateFontVars(){
  document.documentElement.style.setProperty('--font-arabic-size', fontSizeArabic + 'px');
  document.documentElement.style.setProperty('--font-translation-size', fontSizeTranslation + 'px');
  document.documentElement.style.setProperty('--font-transliteration-size', fontSizeTransliteration + 'px');
  document.documentElement.style.setProperty('--arabic-font', `"${fontArabic}", serif`);
}

/* ================== FETCHERS (with cache fallback) ================== */
async function fetchJSONWithCache(url, cacheKey){
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    localStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data}));
    return data;
  }catch(err){
    const cached = localStorage.getItem(cacheKey);
    if(cached){
      setStatus('Offline – using cached data');
      return JSON.parse(cached).data;
    }
    throw err;
  }
}

async function loadCategories(){
  try{
    els.categoriesList.innerHTML = '<li class="loading">Loading categories...</li>';
    const url = `${GITHUB_BASE}categories/${currentLanguage}.json`;
    const cacheKey = `categories_${currentLanguage}`;
    categoriesData = await fetchJSONWithCache(url, cacheKey);
    renderCategories();
    setStatus('Categories loaded');
  }catch(err){
    console.error('Categories error:', err);
    els.categoriesList.innerHTML = '<li class="error">Failed to load categories.</li>';
    setStatus('Failed to load categories');
  }
}

async function loadCategoryDuas(categoryId, categoryName){
  try{
    els.categoryDetails.style.display = 'block';
    els.categoriesList.style.display = 'none';
    els.sectionTitle.textContent = categoryName;
    els.duaContainer.innerHTML = '<div class="loading">Loading duas...</div>';
    const url = `${GITHUB_BASE}duas/categories_${categoryId}/${currentLanguage}.json`;
    const cacheKey = `duas_${categoryId}_${currentLanguage}`;
    duasData = await fetchJSONWithCache(url, cacheKey);
    renderDuas();
    setStatus('Duas loaded');
  }catch(err){
    console.error('Duas error:', err);
    els.duaContainer.innerHTML = '<div class="error">Failed to load duas.</div>';
    setStatus('Failed to load duas');
  }
}

/* ================== RENDERERS ================== */
function renderCategories(filter=''){
  const ul = els.categoriesList; ul.innerHTML = '';
  let filtered = categoriesData;
  if(filter){
    filtered = categoriesData.filter(cat=>cat.title.toLowerCase().includes(filter.toLowerCase()));
  }
  if(!filtered.length){ ul.innerHTML = '<li class="no-results">No categories available</li>'; return; }
  filtered.forEach((cat, idx)=>{
    // Note: we assume category id is (idx+1) matching your folder names categories_1, categories_2, ...
    const li = document.createElement('li'); li.className = 'category-item';
    li.innerHTML = `
      <div class="category-arrow"><i class="fas fa-chevron-right"></i></div>
      <div class="category-title">${cat.title}</div>
      <div class="category-count">${idx+1}</div>
    `;
    li.addEventListener('click', ()=>loadCategoryDuas(idx+1, cat.title));
    ul.appendChild(li);
  });
}

function renderDuas(filter=''){
  const container = els.duaContainer; container.innerHTML = '';
  let list = duasData;

  if(viewingFavorites){
    const favKeys = Object.keys(favorites).filter(k=>favorites[k]);
    list = duasData.filter(d=> favKeys.includes(String(d.id)));
  }

  if(filter){
    const f = filter.toLowerCase();
    list = list.filter(dua => 
      (dua.translation && dua.translation.toLowerCase().includes(f)) ||
      (dua.transliteration && dua.transliteration.toLowerCase().includes(f)) ||
      (dua.arabic && dua.arabic.includes(filter))
    );
  }

  if(!list.length){ container.innerHTML = '<div class="no-results">No duas available</div>'; updateFavCount(); return; }

  list.forEach(dua=>{
    const isFav = !!favorites[dua.id];
    const d = document.createElement('div'); d.className = 'dua-item';

    const translitHtml = showTransliterations && dua.transliteration ? `<div class="dua-transliteration">${dua.transliteration}</div>` : '';
    const transHtml = showTranslations && dua.translation ? `<div class="dua-translation">${dua.translation}</div>` : '';

    d.innerHTML = `
      <div class="dua-header">
        <div class="ref-left">${dua.reference ? dua.reference : ''}</div>
        <div class="ref-right"></div>
      </div>
      ${dua.arabic ? `<div class="dua-arabic">${dua.arabic}</div>` : ''}
      ${translitHtml}
      ${transHtml}
      ${dua.source ? `<div class="dua-reference">${dua.source}</div>` : ''}
      <div class="dua-actions">
        <button class="icon-btn fav ${isFav?'active':''}" title="Favorite"><i class="fa fa-heart"></i></button>
        <button class="icon-btn share" title="Share"><i class="fa fa-share-nodes"></i></button>
        <button class="icon-btn save" title="Save"><i class="fa fa-download"></i></button>
        <button class="icon-btn copy" title="Copy"><i class="fa fa-copy"></i></button>
      </div>
    `;

    // actions
    d.querySelector('.fav').addEventListener('click', ()=>{
      favorites[dua.id] = !favorites[dua.id];
      localStorage.setItem('favorites', JSON.stringify(favorites));
      d.querySelector('.fav').classList.toggle('active', !!favorites[dua.id]);
      updateFavCount();
      toast(favorites[dua.id] ? 'Added to favorites' : 'Removed from favorites','success',2000);
    });

    d.querySelector('.share').addEventListener('click', async ()=>{
      const text = buildDuaPlainText(dua);
      if(navigator.share){
        try{ await navigator.share({title:'Dua', text}); toast('Shared','success',2000);}catch(e){}
      }else{
        await copyToClipboard(text);
        toast('Copied for sharing','info',2000);
      }
    });

    d.querySelector('.save').addEventListener('click', ()=>{
      const text = buildDuaPlainText(dua);
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `dua_${dua.id||'item'}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('Saved as file','success',2000);
    });

    d.querySelector('.copy').addEventListener('click', async ()=>{
      await copyToClipboard(buildDuaPlainText(dua));
      toast('Copied','success',2000);
    });

    container.appendChild(d);
  });

  updateFavCount();
}

function buildDuaPlainText(dua){
  let t = '';
  if(dua.arabic) t += dua.arabic + '\n\n';
  if(showTransliterations && dua.transliteration) t += dua.transliteration + '\n\n';
  if(showTranslations && dua.translation) t += dua.translation + '\n\n';
  if(dua.reference) t += '('+dua.reference+')\n';
  if(dua.source) t += 'Source: '+dua.source+'\n';
  return t.trim();
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); }catch(_){}; document.body.removeChild(ta);
  }
}

function updateFavCount(){
  const count = Object.values(favorites).filter(Boolean).length;
  document.querySelector('.fav-count').textContent = count;
}

/* ================== EVENTS ================== */
// Language cycle (header icon)
document.getElementById('languageToggle').addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.currentLangLabel.textContent = currentLanguage.toUpperCase();
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  savePrefs();
  loadCategories();
});

// Back button
els.backBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  viewingFavorites = false;
  setStatus('Back to categories');
});

// Theme toggle (icon only toggles between a light preset and a dark preset)
els.themeToggle.addEventListener('click', ()=>{
  // toggle between current and Dark theme quickly
  if(themeIndex === 21){ // Dark preset index in list is 21 (0-based? we added 25; check index)
    themeIndex = 0;
  }else{
    themeIndex = 21; // Dark
  }
  applyTheme(THEMES[themeIndex]);
  savePrefs();
  // icon swap
  const icon = els.themeToggle.querySelector('i');
  icon.className = (themeIndex === 21) ? 'fas fa-sun' : 'fas fa-moon';
});

// Search toggle
els.searchToggle.addEventListener('click', ()=>{
  els.searchBarContainer.style.display = els.searchBarContainer.style.display === 'none' ? 'block' : 'none';
  els.searchBar.focus();
});

// Search input filter
els.searchBar.addEventListener('input', ()=>{
  if(els.categoryDetails.style.display === 'block'){
    renderDuas(els.searchBar.value);
  } else {
    renderCategories(els.searchBar.value);
  }
});

// Favorites quick filter in footer bar
els.favOnlyBtn.addEventListener('click', ()=>{
  if(els.categoryDetails.style.display !== 'block'){
    toast('Open a category first','warn',2000);
    return;
  }
  viewingFavorites = !viewingFavorites;
  els.favOnlyBtn.classList.toggle('active', viewingFavorites);
  renderDuas(els.searchBar.value);
});

// Favorites view badge at header
els.favoritesViewBtn.addEventListener('click', ()=>{
  if(els.categoryDetails.style.display !== 'block'){
    toast('Open a category first','warn',2000);
    return;
  }
  viewingFavorites = !viewingFavorites;
  els.favoritesViewBtn.classList.toggle('active', viewingFavorites);
  renderDuas(els.searchBar.value);
});

// Home
els.homeBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  viewingFavorites = false;
});

// About modal
els.aboutBtn.addEventListener('click', ()=> els.aboutModal.classList.add('show'));
els.closeAbout.addEventListener('click', ()=> els.aboutModal.classList.remove('show'));
els.aboutModal.addEventListener('click', (e)=>{ if(e.target===els.aboutModal) els.aboutModal.classList.remove('show'); });

// Settings sheet
els.settingsFab.addEventListener('click', ()=> els.settingsSheet.classList.add('show'));
els.closeSettings.addEventListener('click', ()=> els.settingsSheet.classList.remove('show'));

// Settings: Display toggles
function syncDisplayControls(){
  // toggles
  els.toggleTranslations.checked = !!showTranslations;
  els.toggleTransliterations.checked = !!showTransliterations;
  // switches background color hint
  els.toggleTranslationsSwitch.classList.toggle('on', !!showTranslations);
  els.toggleTransliterationsSwitch.classList.toggle('on', !!showTransliterations);

  // ranges
  els.arabicSize.value = fontSizeArabic; els.arabicSizeVal.textContent = fontSizeArabic+'px';
  els.translationSize.value = fontSizeTranslation; els.translationSizeVal.textContent = fontSizeTranslation+'px';
  els.transliterationSize.value = fontSizeTransliteration; els.transliterationSizeVal.textContent = fontSizeTransliteration+'px';

  // font select
  els.arabicFont.value = fontArabic;
}

els.toggleTranslations.addEventListener('change', ()=>{
  showTranslations = els.toggleTranslations.checked;
  els.toggleTranslationsSwitch.classList.toggle('on', showTranslations);
  savePrefs();
  if(els.categoryDetails.style.display==='block') renderDuas(els.searchBar.value);
});

els.toggleTransliterations.addEventListener('change', ()=>{
  showTransliterations = els.toggleTransliterations.checked;
  els.toggleTransliterationsSwitch.classList.toggle('on', showTransliterations);
  savePrefs();
  if(els.categoryDetails.style.display==='block') renderDuas(els.searchBar.value);
});

els.arabicSize.addEventListener('input', ()=>{
  fontSizeArabic = parseInt(els.arabicSize.value,10);
  els.arabicSizeVal.textContent = fontSizeArabic+'px';
  updateFontVars(); savePrefs();
});
els.translationSize.addEventListener('input', ()=>{
  fontSizeTranslation = parseInt(els.translationSize.value,10);
  els.translationSizeVal.textContent = fontSizeTranslation+'px';
  updateFontVars(); savePrefs();
});
els.transliterationSize.addEventListener('input', ()=>{
  fontSizeTransliteration = parseInt(els.transliterationSize.value,10);
  els.transliterationSizeVal.textContent = fontSizeTransliteration+'px';
  updateFontVars(); savePrefs();
});
els.arabicFont.addEventListener('change', ()=>{
  fontArabic = els.arabicFont.value;
  updateFontVars(); savePrefs();
});

// Theme grid
function buildThemeGrid(){
  els.themeGrid.innerHTML = '';
  THEMES.forEach((t,idx)=>{
    const card = document.createElement('div');
    card.className = 'theme-card';
    card.title = t.name;
    card.innerHTML = `<div class="swatch" style="background:linear-gradient(135deg, ${t.primary}, ${t.secondary}); border:2px solid ${t.border}"></div>`;
    card.addEventListener('click', ()=>{
      themeIndex = idx;
      applyTheme(t);
      savePrefs();
      toast(`Theme: ${t.name}`,'success',1200);
    });
    els.themeGrid.appendChild(card);
  });
}
els.openThemeGridBtn.addEventListener('click', ()=>{
  els.themeGrid.style.display = els.themeGrid.style.display==='none' ? 'grid' : 'none';
});

// Custom theme apply
els.applyCustomTheme.addEventListener('click', ()=>{
  customTheme = {
    primary: els.cPrimary.value,
    secondary: els.cSecondary.value,
    accent: els.cAccent.value,
    bg: els.cBg.value,
    text: els.cText.value,
    border: els.cBorder.value,
    card: els.cCard.value,
  };
  applyTheme(customTheme);
  savePrefs();
  toast('Custom theme applied','success',1600);
});

// Settings: language section
els.currentLangLabel.textContent = currentLanguage.toUpperCase();
els.cycleLangBtn.addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.currentLangLabel.textContent = currentLanguage.toUpperCase();
  savePrefs();
  // back to categories on switch
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  loadCategories();
});

/* ================== INIT ================== */
function initTheme(){
  if(customTheme){ applyTheme(customTheme); }
  else applyTheme(THEMES[themeIndex] || THEMES[0]);
  // set icon according to theme darkness
  const icon = els.themeToggle.querySelector('i');
  icon.className = (themeIndex === 21) ? 'fas fa-sun' : 'fas fa-moon';
}
function init(){
  els.languageText.textContent = currentLanguage.toUpperCase();
  updateFontVars();
  initTheme();
  buildThemeGrid();
  syncDisplayControls();
  loadCategories();
  setStatus('Ready');
}
init();
</script>
</body>
</html>
