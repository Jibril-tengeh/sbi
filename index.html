<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Adhkar Application</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ============ RESET & THEME VARS ============ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#16a34a;
  --secondary:#0e9f6e;
  --accent:#f05252;
  --bg:#f9fafb;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --card:#ffffff;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
  --font-arabic-size: 22px;
  --font-translation-size: 16px;
  --font-transliteration-size: 16px;
  --arabic-font: "Amiri", serif;
  --bottom-header-h: 56px;
}
html,body{height:100%}
body{
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  transition:background .25s,color .25s
}
.theme-fade{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .35s ease;z-index:9999}
.theme-fade.show{opacity:1}

/* ============ HEADER (TOP) ============ */
header{
  position:sticky;top:0;z-index:30;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,.12);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.logo{display:flex;gap:10px;align-items:center;font-weight:700;font-size:1.1rem}
.header-icons{display:flex;gap:10px;align-items:center}
.header-icon{
  width:38px;height:38px;border-radius:999px;background:rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s,background .2s;position:relative
}
.header-icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.28)}
.language-text{position:absolute;bottom:-16px;font-size:.68rem;font-weight:600;letter-spacing:.04em}

/* Search bar */
#searchBarContainer{
  width:100%;padding:8px;background:rgba(255,255,255,0.2);
  display:none;
}
#searchBar{
  width:100%;padding:8px 12px;border:none;border-radius:8px;font-size:1rem;
}

/* ============ MAIN ============ */
.container{max-width:1000px;margin:16px auto calc(var(--bottom-header-h) + 18px);padding:0 14px}
.section-title-wrap{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.section-title{margin:6px 0 6px;color:var(--primary);font-size:1.5rem}

/* ============ LISTS ============ */
.categories-list{list-style:none;max-width:860px;margin:0 auto}
.category-item{
  background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;gap:12px;align-items:center;margin-bottom:10px;
  box-shadow:var(--shadow);transition:border-color .2s,transform .16s,box-shadow .16s;cursor:pointer
}
.category-item:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.category-arrow{color:var(--primary);font-size:1rem}
.category-title{flex:1;font-weight:600}
.category-count{min-width:34px;text-align:center;color:var(--primary);font-weight:700}

/* ============ DUA VIEW ============ */
.back-btn{
  display:inline-flex;gap:8px;align-items:center;margin:6px 0 12px 2px;padding:10px 14px;
  background:var(--primary);color:white;border:none;border-radius:10px;cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.18);transition:transform .15s,opacity .15s
}
.back-btn:hover{transform:translateY(-1px)}
.dua-list{max-width:860px;margin:0 auto 20px}
.dua-item{
  background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:var(--shadow);position:relative
}
.dua-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;color:var(--muted);font-size:.9rem}
.dua-arabic{
  font-size:var(--font-arabic-size);line-height:2;direction:rtl;text-align:right;margin-bottom:6px;
  font-family:var(--arabic-font);
}
.dua-transliteration{font-size:var(--font-transliteration-size);font-style:italic;margin-top:4px;color:#374151}
.dua-translation{font-size:var(--font-translation-size);margin-top:6px}
.dua-reference{margin-top:6px;color:var(--muted);font-size:.92rem}
.dua-actions{
  display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;padding-top:8px;border-top:1px dashed var(--border)
}
.icon-btn{
  display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer;transition:transform .12s,border-color .12s,background .12s;
}
.icon-btn:hover{transform:translateY(-1px);border-color:var(--primary)}
.icon-btn.fav.active{color:#b91c1c;border-color:#b91c1c}

/* ============ STATES ============ */
.loading,.error,.no-results{text-align:center;color:var(--muted);padding:18px}

/* ============ SETTINGS FAB (bottom-right transparent) ============ */
.fab{
  position:fixed;right:15px;bottom:calc(var(--bottom-header-h) + 15px);z-index:60;
  width:52px;height:52px;border-radius:999px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  background:transparent;color:#111827;
}
.fab i{font-size:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
.fab:hover{transform:translateY(-1px)}

/* ============ MODAL (centered) ============ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(110%) blur(2px);
  display:none;align-items:center;justify-content:center;z-index:70;
}
.modal-overlay.show{display:flex;animation:fadeIn .18s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{
  width:min(92vw,720px);max-height:80vh;overflow:auto;background:var(--card);color:var(--text);
  border-radius:16px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.modal-title{font-weight:800;font-size:1.05rem}
.modal-body{padding:12px 14px}

/* collapsible sections */
.section{border:1px solid var(--border);border-radius:12px;background:var(--card);margin-bottom:12px;box-shadow:var(--shadow);overflow:hidden}
.section summary{
  list-style:none;cursor:pointer;padding:12px 14px;font-weight:700;display:flex;align-items:center;justify-content:space-between
}
.section summary::-webkit-details-marker{display:none}
.section .section-body{padding:10px 14px 12px;border-top:1px dashed var(--border)}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
.row label{font-size:.95rem}
.row .controls{display:flex;align-items:center;gap:8px}
.switch{position:relative;width:48px;height:26px;border-radius:999px;background:#e5e7eb;cursor:pointer;flex-shrink:0;border:1px solid var(--border)}
.switch input{display:none}
.switch.on{background:#22c55e}
.thumb{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:white;box-shadow:var(--shadow);transition:left .18s}
.switch.on .thumb{left:24px}
input[type="range"]{width:160px}
select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}

/* ============ BOTTOM HEADER (persistent) ============ */
.bottom-header{
  position:fixed;left:0;right:0;bottom:0;z-index:50;
  height:var(--bottom-header-h);
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -4px 18px rgba(0,0,0,.06);
}
.bottom-header .bar{
  max-width:1000px;height:100%;margin:0 auto;padding:6px 12px;display:flex;align-items:center;justify-content:space-between;
}
.bh-left,.bh-right{display:flex;gap:8px;align-items:center}
.pill-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--text);box-shadow:var(--shadow);font-size:.92rem;cursor:pointer}
.pill-btn.active{border-color:var(--primary);color:var(--primary)}

/* Toasts (copy/share etc.) */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--bottom-header-h) + 18px);
  background:var(--card);color:var(--text);
  border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 14px;border-radius:12px;z-index:80;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s
}
.toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px)}
.toast.success{border-color:#16a34a}
.toast.info{border-color:#2563eb}
.toast.warn{border-color:#f59e0b}
.toast.error{border-color:#ef4444}

/* Dark mode helper (quick) */
.dark body{background:#0b1020;color:#e5e7eb}
</style>
</head>
<body>
<div class="theme-fade" id="themeFade"></div>

<!-- ======= HEADER (TOP) ======= -->
<header>
  <div class="logo"><i class="fas fa-star-and-crescent"></i><span>Adhkar</span></div>
  <div class="header-icons">
    <!-- Order: search — dark mode — languages -->
    <div class="header-icon" id="searchToggle" title="Search"><i class="fas fa-search"></i></div>
    <div class="header-icon" id="themeToggle" title="Toggle Sun/Moon"><i class="fas fa-moon"></i></div>
    <div class="header-icon" id="languageToggle" title="Language">
      <i class="fas fa-language"></i>
      <div class="language-text" id="languageText">EN</div>
    </div>
  </div>
  <!-- Search bar container -->
  <div id="searchBarContainer">
    <input type="text" id="searchBar" placeholder="Search categories or duas...">
  </div>
</header>

<!-- ======= MAIN ======= -->
<div class="container">
  <div class="section-title-wrap">
    <h1 class="section-title">Categories</h1>
  </div>

  <ul id="categoriesList" class="categories-list">
    <li class="loading">Loading categories...</li>
  </ul>

  <div id="categoryDetails" style="display:none;">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
    <div id="duaContainer" class="dua-list"></div>
  </div>
</div>

<!-- ======= FLOATING SETTINGS (transparent) ======= -->
<button class="fab" id="fabSettings" title="Settings" aria-label="Settings">
  <i class="fa fa-sliders"></i>
</button>

<!-- ======= SETTINGS MODAL ======= -->
<div class="modal-overlay" id="settingsOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-head">
      <div class="modal-title" id="settingsTitle">Settings</div>
      <button class="header-icon" id="closeSettings" style="width:36px;height:36px;background:rgba(0,0,0,0.05);color:inherit"><i class="fa fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <!-- Display (OPEN by default) -->
      <details class="section" id="displaySection" open>
        <summary>
          <span id="displayTitle">Display</span>
          <i class="fa fa-chevron-down"></i>
        </summary>
        <div class="section-body">
          <div class="row">
            <label for="toggleTranslations">Show Translations</label>
            <div class="controls">
              <div class="switch" id="toggleTranslationsSwitch">
                <input type="checkbox" id="toggleTranslations">
                <span class="thumb"></span>
              </div>
            </div>
          </div>
          <div class="row">
            <label for="toggleTransliterations">Show Transliteration</label>
            <div class="controls">
              <div class="switch" id="toggleTransliterationsSwitch">
                <input type="checkbox" id="toggleTransliterations">
                <span class="thumb"></span>
              </div>
            </div>
          </div>

          <div class="row">
            <label>Arabic size</label>
            <div class="controls">
              <input type="range" id="arabicSize" min="18" max="44" value="22">
              <span id="arabicSizeVal">22px</span>
            </div>
          </div>
          <div class="row">
            <label>Translation size</label>
            <div class="controls">
              <input type="range" id="translationSize" min="12" max="28" value="16">
              <span id="translationSizeVal">16px</span>
            </div>
          </div>
          <div class="row">
            <label>Transliteration size</label>
            <div class="controls">
              <input type="range" id="transliterationSize" min="12" max="28" value="16">
              <span id="transliterationSizeVal">16px</span>
            </div>
          </div>

          <div class="row">
            <label>Arabic Font</label>
            <div class="controls">
              <select id="arabicFont">
                <option value="Amiri-BoldSlanted">Amiri-BoldSlanted</option>
                <option value="albayan">albayan</option>
                <option value="471btehran">471btehran</option>
                <option value="AmiriQuranColored">AmiriQuranColored</option>
                <option value="amiri-bold">amiri-bold</option>
                <option value="Amiri">Amiri (system)</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- Theme -->
      <details class="section" id="themeSection">
        <summary>
          <span id="themeTitle">Theme</span>
          <i class="fa fa-chevron-down"></i>
        </summary>
        <div class="section-body">
          <div class="row" style="justify-content:flex-start">
            <button class="pill-btn" id="toggleDarkQuick"><i class="fa fa-circle-half-stroke"></i> Quick Dark/Light</button>
          </div>
        </div>
      </details>

      <!-- Language -->
      <details class="section" id="languageSection">
        <summary>
          <span id="languageTitle">Language</span>
          <i class="fa fa-chevron-down"></i>
        </summary>
        <div class="section-body">
          <div class="row">
            <label>Current</label>
            <div class="controls"><span id="currentLangLabel">EN</span></div>
          </div>
          <div class="row">
            <label>Switch</label>
            <div class="controls"><button class="pill-btn" id="cycleLangBtn"><i class="fa fa-language"></i> Cycle</button></div>
          </div>
        </div>
      </details>

      <!-- About (ONLY here) -->
      <details class="section" id="aboutSection">
        <summary>
          <span id="aboutTitle">About</span>
          <i class="fa fa-chevron-down"></i>
        </summary>
        <div class="section-body">
          <p style="margin-bottom:6px">Adhkar & Dua Application</p>
          <p style="color:var(--muted);font-size:.95rem">Developed by <strong>Jibril SBI TENGEH</strong>.</p>
        </div>
      </details>
    </div>
  </div>
</div>

<!-- ======= BOTTOM HEADER ======= -->
<nav class="bottom-header" aria-label="Bottom header">
  <div class="bar">
    <div class="bh-left">
      <button class="pill-btn" id="homeBtn"><i class="fa fa-house"></i> Home</button>
      <button class="pill-btn" id="favoritesBtn"><i class="fa fa-heart"></i> Favorites</button>
    </div>
    <div class="bh-right"><!-- intentionally empty --></div>
  </div>
</nav>

<!-- ======= TOAST ======= -->
<div class="toast" id="toast">Done</div>

<script>
/* ================== CONFIG ================== */
const GITHUB_USER  = "jibril-tengeh";
const GITHUB_REPO  = "sbi";
const GITHUB_BRANCH= "main";
const GITHUB_BASE  = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;

/* ================== STATE ================== */
let currentLanguage = localStorage.getItem('lang') || 'en';
let categoriesData = [];   // [{ id, title, folder }, ...]
let duasData = [];         // current category duas
let currentCategoryFolder = null;

let favorites = JSON.parse(localStorage.getItem('favorites')||'{}'); // {duaKey: duaObject}
let viewingFavorites = false;

let showTransliterations = JSON.parse(localStorage.getItem('showTransliterations')||'true');
let showTranslations = JSON.parse(localStorage.getItem('showTranslations')||'true');

let fontArabic = localStorage.getItem('fontArabic') || 'Amiri';
let fontSizeArabic = parseInt(localStorage.getItem('fontSizeArabic')||'22',10);
let fontSizeTranslation = parseInt(localStorage.getItem('fontSizeTranslation')||'16',10);
let fontSizeTransliteration = parseInt(localStorage.getItem('fontSizeTransliteration')||'16',10);

/* ================== UI ELEMENTS ================== */
const els = {
  categoriesList: document.getElementById('categoriesList'),
  categoryDetails: document.getElementById('categoryDetails'),
  duaContainer: document.getElementById('duaContainer'),
  backBtn: document.getElementById('backBtn'),
  languageText: document.getElementById('languageText'),
  themeToggle: document.getElementById('themeToggle'),
  searchToggle: document.getElementById('searchToggle'),
  searchBarContainer: document.getElementById('searchBarContainer'),
  searchBar: document.getElementById('searchBar'),
  sectionTitle: document.querySelector('.section-title'),
  toast: document.getElementById('toast'),

  // bottom header
  homeBtn: document.getElementById('homeBtn'),
  favoritesBtn: document.getElementById('favoritesBtn'),

  // settings modal & FAB
  fabSettings: document.getElementById('fabSettings'),
  settingsOverlay: document.getElementById('settingsOverlay'),
  closeSettings: document.getElementById('closeSettings'),

  // settings content
  currentLangLabel: document.getElementById('currentLangLabel'),
  cycleLangBtn: document.getElementById('cycleLangBtn'),
  toggleDarkQuick: document.getElementById('toggleDarkQuick'),

  // display controls
  toggleTranslations: document.getElementById('toggleTranslations'),
  toggleTranslationsSwitch: document.getElementById('toggleTranslationsSwitch'),
  toggleTransliterations: document.getElementById('toggleTransliterations'),
  toggleTransliterationsSwitch: document.getElementById('toggleTransliterationsSwitch'),
  arabicSize: document.getElementById('arabicSize'),
  arabicSizeVal: document.getElementById('arabicSizeVal'),
  translationSize: document.getElementById('translationSize'),
  translationSizeVal: document.getElementById('translationSizeVal'),
  transliterationSize: document.getElementById('transliterationSize'),
  transliterationSizeVal: document.getElementById('transliterationSizeVal'),
  arabicFont: document.getElementById('arabicFont'),
};

/* ================== HELPERS ================== */
function toast(msg,type="info",ms=2000){
  els.toast.textContent = msg;
  els.toast.className = `toast ${type} show`;
  setTimeout(()=>{els.toast.classList.remove('show')}, ms);
}
function savePrefs(){
  localStorage.setItem('lang', currentLanguage);
  localStorage.setItem('showTranslations', JSON.stringify(showTranslations));
  localStorage.setItem('showTransliterations', JSON.stringify(showTransliterations));
  localStorage.setItem('fontArabic', fontArabic);
  localStorage.setItem('fontSizeArabic', fontSizeArabic);
  localStorage.setItem('fontSizeTranslation', fontSizeTranslation);
  localStorage.setItem('fontSizeTransliteration', fontSizeTransliteration);
}
function updateFontVars(){
  document.documentElement.style.setProperty('--font-arabic-size', fontSizeArabic + 'px');
  document.documentElement.style.setProperty('--font-translation-size', fontSizeTranslation + 'px');
  document.documentElement.style.setProperty('--font-transliteration-size', fontSizeTransliteration + 'px');
  document.documentElement.style.setProperty('--arabic-font', `"${fontArabic}", serif`);
}
function darkModeOn(isOn){
  document.body.style.background = isOn ? '#0b1020' : 'var(--bg)';
  document.body.style.color = isOn ? '#e5e7eb' : 'var(--text)';
}

/* ================== FETCHERS (with cache fallback) ================== */
async function fetchJSONWithCache(url, cacheKey){
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    localStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data}));
    return data;
  }catch(err){
    const cached = localStorage.getItem(cacheKey);
    if(cached){ return JSON.parse(cached).data; }
    throw err;
  }
}

async function loadCategories(){
  try{
    els.categoriesList.innerHTML = '<li class="loading">Loading categories...</li>';
    const url = `${GITHUB_BASE}categories/${currentLanguage}.json`;
    const cacheKey = `categories_${currentLanguage}`;
    // expected: [{ "id": 1, "title": "...", "folder": "categories_1" }, ...]
    categoriesData = await fetchJSONWithCache(url, cacheKey);
    renderCategories();
  }catch(err){
    console.error('Categories error:', err);
    els.categoriesList.innerHTML = '<li class="error">Failed to load categories.</li>';
  }
}

async function loadCategoryDuas(categoryFolder, categoryName){
  try{
    currentCategoryFolder = categoryFolder;
    els.categoryDetails.style.display = 'block';
    els.categoriesList.style.display = 'none';
    els.sectionTitle.textContent = categoryName;
    els.duaContainer.innerHTML = '<div class="loading">Loading duas...</div>';
    // NOTE: uses "douas" per your repo structure
    const url = `${GITHUB_BASE}douas/${categoryFolder}/${currentLanguage}.json`;
    const cacheKey = `douas_${categoryFolder}_${currentLanguage}`;
    duasData = await fetchJSONWithCache(url, cacheKey);
    renderDuas();
  }catch(err){
    console.error('Duas error:', err);
    els.duaContainer.innerHTML = `
      <div class="error">
        Failed to load duas.<br/>
        <small>Checked: <code>douas/${categoryFolder}/${currentLanguage}.json</code></small>
      </div>`;
  }
}

/* ================== RENDERERS ================== */
function renderCategories(filter=''){
  const ul = els.categoriesList; ul.innerHTML = '';
  let filtered = categoriesData;
  if(filter) filtered = categoriesData.filter(cat=> (cat.title||'').toLowerCase().includes(filter.toLowerCase()));
  if(!filtered.length){ ul.innerHTML = '<li class="no-results">No categories available</li>'; return; }

  filtered.forEach((cat, idx)=>{
    const folder = cat.folder || (cat.id ? `categories_${cat.id}` : `categories_${idx+1}`);
    const li = document.createElement('li'); li.className = 'category-item';
    li.innerHTML = `
      <div class="category-arrow"><i class="fas fa-chevron-right"></i></div>
      <div class="category-title">${cat.title || ('Category ' + (idx+1))}</div>
      <div class="category-count">${cat.id || (idx+1)}</div>
    `;
    li.addEventListener('click', ()=>loadCategoryDuas(folder, cat.title || ('Category ' + (idx+1))));
    ul.appendChild(li);
  });
}

function makeDuaKey(dua, catFolder = currentCategoryFolder, lang = currentLanguage){
  const idPart = dua.id != null ? dua.id : (dua.arabic ? dua.arabic.slice(0,30) : Math.random().toString(36).slice(2));
  return `${catFolder}:${lang}:${idPart}`;
}

function renderDuas(filter=''){
  const container = els.duaContainer; container.innerHTML = '';
  let list;

  if(viewingFavorites){
    // Render from saved favorites (global)
    list = Object.values(favorites || {});
    // filter by search
    if(filter){
      const f = filter.toLowerCase();
      list = list.filter(dua =>
        (dua.translation && dua.translation.toLowerCase().includes(f)) ||
        (dua.transliteration && dua.transliteration.toLowerCase().includes(f)) ||
        (dua.arabic && dua.arabic.includes(filter))
      );
    }
  } else {
    list = duasData.slice();
    if(filter){
      const f = filter.toLowerCase();
      list = list.filter(dua =>
        (dua.translation && dua.translation.toLowerCase().includes(f)) ||
        (dua.transliteration && dua.transliteration.toLowerCase().includes(f)) ||
        (dua.arabic && dua.arabic.includes(filter))
      );
    }
  }

  if(!list.length){ container.innerHTML = '<div class="no-results">No duas available</div>'; return; }

  list.forEach(dua=>{
    const key = makeDuaKey(dua, dua._catFolder || currentCategoryFolder, dua._lang || currentLanguage);
    const isFav = !!favorites[key];

    const d = document.createElement('div'); d.className = 'dua-item';

    d.innerHTML = `
      <div class="dua-header">
        <div class="ref-left">${dua.reference ? dua.reference : ''}</div>
        <div class="ref-right"></div>
      </div>

      ${dua.arabic ? `<div class="dua-arabic">${dua.arabic}</div>` : ''}

      <div class="dua-transliteration" style="display:${showTransliterations && dua.transliteration ? 'block':'none'}">
        ${dua.transliteration ? dua.transliteration : ''}
      </div>

      <div class="dua-translation" style="display:${showTranslations && dua.translation ? 'block':'none'}">
        ${dua.translation ? dua.translation : ''}
      </div>

      ${dua.source ? `<div class="dua-reference">${dua.source}</div>` : ''}

      <div class="dua-actions">
        <button class="icon-btn fav ${isFav?'active':''}" title="Favorite"><i class="fa fa-heart"></i></button>
        <button class="icon-btn share" title="Share"><i class="fa fa-share-nodes"></i></button>
        <button class="icon-btn save" title="Save"><i class="fa fa-download"></i></button>
        <button class="icon-btn copy" title="Copy"><i class="fa fa-copy"></i></button>
      </div>
    `;

    // Favorite
    d.querySelector('.fav').addEventListener('click', ()=>{
      const nowFav = !favorites[key];
      if(nowFav){
        // store full dua object w/ provenance
        const stored = {...dua, _catFolder: dua._catFolder || currentCategoryFolder, _lang: dua._lang || currentLanguage};
        favorites[key] = stored;
      }else{
        delete favorites[key];
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      d.querySelector('.fav').classList.toggle('active', nowFav);
      toast(nowFav ? 'Added to favorites' : 'Removed from favorites','success',1500);
      if(viewingFavorites && !nowFav){ d.remove(); if(!els.duaContainer.children.length) container.innerHTML = '<div class="no-results">No duas available</div>'; }
    });

    // Share
    d.querySelector('.share').addEventListener('click', async ()=>{
      const text = buildDuaPlainText(dua);
      if(navigator.share){
        try{ await navigator.share({title:'Dua', text}); toast('Shared','success',2000);}catch(e){}
      }else{
        await copyToClipboard(text);
        toast('Copied for sharing','info',2000);
      }
    });

    // Save
    d.querySelector('.save').addEventListener('click', ()=>{
      const text = buildDuaPlainText(dua);
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `dua_${dua.id||'item'}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('Saved as file','success',2000);
    });

    // Copy
    d.querySelector('.copy').addEventListener('click', async ()=>{
      await copyToClipboard(buildDuaPlainText(dua));
      toast('Copied','success',2000);
    });

    container.appendChild(d);
  });
}

function buildDuaPlainText(dua){
  let t = '';
  if(dua.arabic) t += dua.arabic + '\n\n';
  if(showTransliterations && dua.transliteration) t += dua.transliteration + '\n\n';
  if(showTranslations && dua.translation) t += dua.translation + '\n\n';
  if(dua.reference) t += '('+dua.reference+')\n';
  if(dua.source) t += 'Source: '+dua.source+'\n';
  return t.trim();
}

async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); }catch(_){}
    document.body.removeChild(ta);
  }
}

/* ================== EVENTS ================== */
// Language cycle (top header icon)
document.getElementById('languageToggle').addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.currentLangLabel.textContent = currentLanguage.toUpperCase();
  savePrefs();
  // reset view
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  loadCategories();
});

// Back button
els.backBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  viewingFavorites = false;
  els.favoritesBtn.classList.remove('active');
});

// Theme toggle (top header quick)
els.themeToggle.addEventListener('click', ()=>{
  const icon = els.themeToggle.querySelector('i');
  const isMoon = icon.classList.contains('fa-moon');
  icon.className = isMoon ? 'fas fa-sun' : 'fas fa-moon';
  darkModeOn(isMoon);
});

// Search UI
els.searchToggle.addEventListener('click', ()=>{
  els.searchBarContainer.style.display = els.searchBarContainer.style.display === 'none' ? 'block' : 'none';
  els.searchBar.focus();
});
els.searchBar.addEventListener('input', ()=>{
  if(els.categoryDetails.style.display === 'block'){ renderDuas(els.searchBar.value); }
  else{ renderCategories(els.searchBar.value); }
});

// Bottom header buttons
els.homeBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  viewingFavorites = false;
  els.favoritesBtn.classList.remove('active');
});
els.favoritesBtn.addEventListener('click', ()=>{
  viewingFavorites = true;
  els.favoritesBtn.classList.add('active');
  els.categoriesList.style.display = 'none';
  els.categoryDetails.style.display = 'block';
  els.sectionTitle.textContent = 'Favorites';
  renderDuas(els.searchBar.value);
});

// Settings FAB + Modal
els.fabSettings.addEventListener('click', ()=> els.settingsOverlay.classList.add('show'));
els.closeSettings.addEventListener('click', ()=> els.settingsOverlay.classList.remove('show'));
els.settingsOverlay.addEventListener('click', (e)=>{ if(e.target===els.settingsOverlay) els.settingsOverlay.classList.remove('show') });

// Settings: Display toggles — WORKING instantly
function syncDisplayControls(){
  els.toggleTranslations.checked = !!showTranslations;
  els.toggleTransliterations.checked = !!showTransliterations;
  els.toggleTranslationsSwitch.classList.toggle('on', !!showTranslations);
  els.toggleTransliterationsSwitch.classList.toggle('on', !!showTransliterations);

  els.arabicSize.value = fontSizeArabic; els.arabicSizeVal.textContent = fontSizeArabic+'px';
  els.translationSize.value = fontSizeTranslation; els.translationSizeVal.textContent = fontSizeTranslation+'px';
  els.transliterationSize.value = fontSizeTransliteration; els.transliterationSizeVal.textContent = fontSizeTransliteration+'px';

  els.arabicFont.value = fontArabic;
}
els.toggleTranslations.addEventListener('change', ()=>{
  showTranslations = els.toggleTranslations.checked;
  els.toggleTranslationsSwitch.classList.toggle('on', showTranslations);
  savePrefs();
  document.querySelectorAll('.dua-translation').forEach(n=>{
    n.style.display = showTranslations ? 'block':'none';
  });
  toast(showTranslations?'Translations ON':'Translations OFF','info',1200);
});
els.toggleTransliterations.addEventListener('change', ()=>{
  showTransliterations = els.toggleTransliterations.checked;
  els.toggleTransliterationsSwitch.classList.toggle('on', showTransliterations);
  savePrefs();
  document.querySelectorAll('.dua-transliteration').forEach(n=>{
    n.style.display = showTransliterations ? 'block':'none';
  });
  toast(showTransliterations?'Transliteration ON':'Transliteration OFF','info',1200);
});

els.arabicSize.addEventListener('input', ()=>{
  fontSizeArabic = parseInt(els.arabicSize.value,10);
  els.arabicSizeVal.textContent = fontSizeArabic+'px';
  updateFontVars(); savePrefs();
});
els.translationSize.addEventListener('input', ()=>{
  fontSizeTranslation = parseInt(els.translationSize.value,10);
  els.translationSizeVal.textContent = fontSizeTranslation+'px';
  updateFontVars(); savePrefs();
});
els.transliterationSize.addEventListener('input', ()=>{
  fontSizeTransliteration = parseInt(els.transliterationSize.value,10);
  els.transliterationSizeVal.textContent = fontSizeTransliteration+'px';
  updateFontVars(); savePrefs();
});
els.arabicFont.addEventListener('change', ()=>{
  fontArabic = els.arabicFont.value;
  updateFontVars(); savePrefs();
});

// Settings: theme quick toggle (inside modal)
els.toggleDarkQuick.addEventListener('click', ()=>{
  const isDark = document.body.style.background !== '' && document.body.style.background !== 'var(--bg)';
  darkModeOn(!isDark);
});

// Language cycle inside settings
els.cycleLangBtn.addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.currentLangLabel.textContent = currentLanguage.toUpperCase();
  savePrefs();
  // Reset to categories and reload
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  els.sectionTitle.textContent = 'Categories';
  viewingFavorites = false;
  els.favoritesBtn.classList.remove('active');
  loadCategories();
});

// INIT
function init(){
  els.languageText.textContent = currentLanguage.toUpperCase();
  els.currentLangLabel.textContent = currentLanguage.toUpperCase();
  updateFontVars();
  syncDisplayControls();
  loadCategories();
}
init();
</script>
</body>
</html>
```0
