<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Adhkar Application</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* ============ RESET & THEME VARS ============ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#16a34a;
  --secondary:#0e9f6e;
  --accent:#f05252;
  --bg:#f9fafb;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --card:#ffffff;
  --card-contrast:#1f2937;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
  --font-arabic-size: 1.35rem;
  --font-translation-size: 1rem;
  --font-transliteration-size: 1rem;
  --arabic-font: "Amiri-BoldSlanted", serif; /* default */
}

/* Dark mode baseline — keeps primary/secondary from theme, adjusts surfaces */
body.dark{
  --bg:#111827;
  --text:#f3f4f6;
  --card:#1f2937;
  --border:#374151;
  --muted:#9ca3af;
}

html,body{height:100%}
body{
  background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  transition:background .25s,color .25s
}
.theme-fade{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .35s ease;z-index:9999}
.theme-fade.show{opacity:1}

/* ============ HEADER ============ */
header{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,.12);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.logo{display:flex;gap:10px;align-items:center;font-weight:700;font-size:1.1rem}
.header-icons{display:flex;gap:10px;align-items:center}
.header-icon{
  width:38px;height:38px;border-radius:999px;background:rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s,background .2s;position:relative
}
.header-icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.28)}
.language-text{position:absolute;bottom:-16px;font-size:.68rem;font-weight:600;letter-spacing:.04em}

/* Search bar */
#searchBarContainer{
  width:100%;padding:8px;background:rgba(255,255,255,0.2);
  display:none; /* hidden until toggled */
}
#searchBar{
  width:100%;padding:8px 12px;border:none;border-radius:8px;font-size:1rem;
}

/* ============ LAYOUT ============ */
.container{max-width:1000px;margin:16px auto 90px;padding:0 14px}
.section-title{text-align:center;margin:6px 0 16px;color:var(--primary);font-size:1.5rem}

/* ============ LISTS ============ */
.categories-list{list-style:none;max-width:860px;margin:0 auto}
.category-item{
  background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;gap:12px;align-items:center;margin-bottom:10px;
  box-shadow:var(--shadow);transition:border-color .2s,transform .16s,box-shadow .16s;cursor:pointer
}
.category-item:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.category-arrow{color:var(--primary);font-size:1rem}
.category-title{flex:1;font-weight:600}
.category-count{min-width:34px;text-align:center;color:var(--primary);font-weight:700}

/* ============ DUA VIEW ============ */
.back-btn{
  display:inline-flex;gap:8px;align-items:center;margin:6px 0 12px 2px;padding:10px 14px;
  background:var(--primary);color:white;border:none;border-radius:10px;cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.18);transition:transform .15s,opacity .15s
}
.back-btn:hover{transform:translateY(-1px)}
.dua-list{max-width:860px;margin:0 auto 20px}
.dua-item{
  background:var(--card);border-left:5px solid var(--primary);border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:var(--shadow)
}
.dua-arabic{
  font-size:var(--font-arabic-size);line-height:2;direction:rtl;text-align:right;margin-bottom:6px;
  font-family:var(--arabic-font, "Amiri-BoldSlanted"), serif;
}
.dua-transliteration{font-size:var(--font-transliteration-size);font-style:italic;margin-top:4px;color:#374151}
.dua-translation{font-size:var(--font-translation-size);margin-top:6px}
.dua-reference{margin-top:6px;color:var(--muted);font-size:.92rem}

/* ============ STATES ============ */
.loading,.error,.no-results{text-align:center;color:var(--muted);padding:18px}

/* ============ SETTINGS ============ */
#settingsIcon{
  position:fixed;right:15px;bottom:15px;z-index:40;
  width:48px;height:48px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.22);backdrop-filter: blur(8px);
  color:#fff;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);
  transition:transform .15s,opacity .15s;
}
#settingsIcon:hover{transform:translateY(-2px)}

.settings-panel{
  position:fixed;top:0;right:-360px;height:100%;width:360px;max-width:92vw;z-index:50;
  background:var(--card);color:var(--text);border-left:1px solid var(--border);
  box-shadow:-8px 0 24px rgba(0,0,0,.18);transition:right .25s ease;
  display:flex;flex-direction:column;
}
.settings-panel.open{right:0}
.settings-header{
  padding:14px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;font-weight:700;color:var(--primary)
}
.settings-body{padding:14px 16px;overflow:auto;flex:1}
.settings-group{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed var(--border)}
.settings-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0}
.settings-row label{font-weight:600}
.switch{
  position:relative;width:48px;height:26px;background:#d1d5db;border-radius:999px;cursor:pointer;flex:none
}
.switch input{display:none}
.switch::after{
  content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:999px;background:#fff;transition:left .2s
}
.switch input:checked + .knob{left:25px}
.knob{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:999px;background:#fff;transition:left .2s}

.button{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);box-shadow:var(--shadow);cursor:pointer
}
.button:hover{transform:translateY(-1px)}

.font-size-controls{display:flex;gap:8px}
.font-btn{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;box-shadow:var(--shadow)
}
.select, select{
  width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)
}

.theme-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px
}
.theme-tile{
  border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow);
}
.theme-sample{
  height:48px;display:flex;
}
.theme-swatch{flex:1}
.theme-name{padding:6px 8px;font-size:.9rem;text-align:center}

.theme-actions{display:flex;gap:8px;margin-top:10px}
.color-input{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.color-input input{width:100%;height:38px;padding:0;border:1px solid var(--border);border-radius:10px}

/* Settings footer (INSIDE panel) */
.settings-footer{
  padding:12px 16px;border-top:1px solid var(--border);font-size:.92rem;color:var(--muted);
}

/* ============ FONTS (example @font-face; replace URLs with your actual files) ============ */
@font-face{
  font-family:"Amiri-BoldSlanted";
  src:url("fonts/Amiri-BoldSlanted.ttf") format("truetype");
  font-display:swap;
}
@font-face{
  font-family:"albayan";
  src:url("fonts/albayan.ttf") format("truetype");
  font-display:swap;
}
@font-face{
  font-family:"471btehran";
  src:url("fonts/471btehran.ttf") format("truetype");
  font-display:swap;
}
@font-face{
  font-family:"AmiriQuranColored";
  src:url("fonts/AmiriQuranColored.ttf") format("truetype");
  font-display:swap;
}
@font-face{
  font-family:"amiri-bold";
  src:url("fonts/amiri-bold.ttf") format("truetype");
  font-display:swap;
}
</style>
</head>
<body>
<div class="theme-fade" id="themeFade"></div>

<!-- ======= HEADER ======= -->
<header>
  <div class="logo"><i class="fas fa-star-and-crescent"></i><span>Adhkar</span></div>
  <div class="header-icons">
    <!-- Search Icon -->
    <div class="header-icon" id="searchToggle" title="Search">
      <i class="fas fa-search"></i>
    </div>
    <!-- Dark Mode -->
    <div class="header-icon" id="themeToggle" title="Toggle Sun/Moon">
      <i class="fas fa-moon"></i>
    </div>
    <!-- Language -->
    <div class="header-icon" id="languageToggle" title="Language">
      <i class="fas fa-language"></i>
      <div class="language-text" id="languageText">EN</div>
    </div>
  </div>
  <!-- Search bar container -->
  <div id="searchBarContainer">
    <input type="text" id="searchBar" placeholder="Search categories or duas...">
  </div>
</header>

<!-- ======= MAIN ======= -->
<div class="container">
  <h1 class="section-title">Categories</h1>
  <ul id="categoriesList" class="categories-list">
    <li class="loading">Loading categories...</li>
  </ul>
  <div id="categoryDetails" style="display:none;">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i> <span id="labelBack">Back</span></button>
    <div id="duaContainer" class="dua-list"></div>
  </div>
</div>

<!-- ======= SETTINGS ICON ======= -->
<div id="settingsIcon" title="Settings" aria-label="Settings"><i class="fas fa-cog"></i></div>

<!-- ======= SETTINGS PANEL ======= -->
<aside id="settingsPanel" class="settings-panel" aria-hidden="true">
  <div class="settings-header">
    <span id="labelSettings">Settings</span>
    <button class="button" id="closeSettings"><i class="fas fa-times"></i></button>
  </div>

  <div class="settings-body" id="settingsMain">
    <div class="settings-group">
      <div class="settings-row">
        <label for="toggleTranslations" id="labelShowTranslations">Show translations</label>
        <div class="switch">
          <input type="checkbox" id="toggleTranslations" />
          <div class="knob"></div>
        </div>
      </div>
      <div class="settings-row">
        <label for="toggleTransliterations" id="labelShowTransliterations">Show transliterations</label>
        <div class="switch">
          <input type="checkbox" id="toggleTransliterations" />
          <div class="knob"></div>
        </div>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-row">
        <label id="labelArabicFont">Arabic font</label>
        <select id="arabicFontSelect" class="select">
          <option value="Amiri-BoldSlanted">Amiri-BoldSlanted</option>
          <option value="albayan">albayan</option>
          <option value="471btehran">471btehran</option>
          <option value="AmiriQuranColored">AmiriQuranColored</option>
          <option value="amiri-bold">amiri-bold</option>
        </select>
      </div>
      <div class="settings-row">
        <label id="labelFontSize">Arabic font size</label>
        <div class="font-size-controls">
          <button class="font-btn" id="fontSmaller" title="A−">A−</button>
          <button class="font-btn" id="fontLarger" title="A+">A+</button>
        </div>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-row" style="justify-content:flex-start;">
        <button class="button" id="openThemes"><i class="fas fa-palette"></i><span id="labelOpenThemes">Themes</span></button>
      </div>
    </div>
  </div>

  <!-- Theme Selection View -->
  <div class="settings-body" id="settingsThemes" style="display:none;">
    <div class="settings-row" style="justify-content:space-between;">
      <button class="button" id="backToMain"><i class="fas fa-arrow-left"></i><span id="labelBackToMain">Back</span></button>
      <strong id="labelChooseTheme">Choose a theme</strong>
    </div>

    <div id="themeGrid" class="theme-grid"></div>

    <div class="settings-group">
      <div class="settings-row" style="justify-content:flex-start;">
        <strong id="labelCustomTheme">Custom theme</strong>
      </div>
      <div class="theme-actions">
        <div class="color-input">
          <label for="colorPrimary" id="labelPrimary">Primary</label>
          <input type="color" id="colorPrimary" value="#16a34a">
        </div>
        <div class="color-input">
          <label for="colorSecondary" id="labelSecondary">Secondary</label>
          <input type="color" id="colorSecondary" value="#0e9f6e">
        </div>
        <div class="color-input">
          <label for="colorBg" id="labelBg">Background</label>
          <input type="color" id="colorBg" value="#f9fafb">
        </div>
        <div class="color-input">
          <label for="colorText" id="labelText">Text</label>
          <input type="color" id="colorText" value="#111827">
        </div>
      </div>
      <div class="settings-row" style="justify-content:flex-start;margin-top:8px;">
        <button class="button" id="applyCustom"><i class="fas fa-check"></i><span id="labelApply">Apply</span></button>
        <button class="button" id="saveCustom"><i class="fas fa-save"></i><span id="labelSave">Save as My Theme</span></button>
      </div>
    </div>
  </div>

  <div class="settings-footer">
    <span id="labelDevelopedBy">Developed by Jibril SBI TENGEH</span>
  </div>
</aside>

<script>
/* ========= ORIGINAL STATE (unchanged) ========= */
let currentLanguage = 'en';
let categoriesData = [];
let duasData = [];
let showTransliterations = true;
let showTranslations = true;

const els = {
  categoriesList: document.getElementById('categoriesList'),
  categoryDetails: document.getElementById('categoryDetails'),
  duaContainer: document.getElementById('duaContainer'),
  backBtn: document.getElementById('backBtn'),
  languageText: document.getElementById('languageText'),
  themeToggle: document.getElementById('themeToggle'),
  searchToggle: document.getElementById('searchToggle'),
  searchBarContainer: document.getElementById('searchBarContainer'),
  searchBar: document.getElementById('searchBar'),

  // Settings
  settingsIcon: document.getElementById('settingsIcon'),
  settingsPanel: document.getElementById('settingsPanel'),
  closeSettings: document.getElementById('closeSettings'),
  settingsMain: document.getElementById('settingsMain'),
  settingsThemes: document.getElementById('settingsThemes'),
  openThemes: document.getElementById('openThemes'),
  backToMain: document.getElementById('backToMain'),
  toggleTranslations: document.getElementById('toggleTranslations'),
  toggleTransliterations: document.getElementById('toggleTransliterations'),
  arabicFontSelect: document.getElementById('arabicFontSelect'),
  fontSmaller: document.getElementById('fontSmaller'),
  fontLarger: document.getElementById('fontLarger'),
  themeGrid: document.getElementById('themeGrid'),
  colorPrimary: document.getElementById('colorPrimary'),
  colorSecondary: document.getElementById('colorSecondary'),
  colorBg: document.getElementById('colorBg'),
  colorText: document.getElementById('colorText'),
  applyCustom: document.getElementById('applyCustom'),
  saveCustom: document.getElementById('saveCustom'),
};

/* ================== FETCHING (unchanged) ================== */
async function loadCategories(){
  try{
    els.categoriesList.innerHTML = '<li class="loading">Loading categories...</li>';
    const res = await fetch(`categories/${currentLanguage}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    categoriesData = await res.json();
    renderCategories();
  }catch(err){
    console.error('Categories error:', err);
    els.categoriesList.innerHTML = '<li class="error">Failed to load categories.</li>';
  }
}

function renderCategories(filter=''){
  const ul = els.categoriesList; ul.innerHTML = '';
  let filtered = categoriesData;
  if(filter){
    filtered = categoriesData.filter(cat=>cat.title.toLowerCase().includes(filter.toLowerCase()));
  }
  if(!filtered.length){ ul.innerHTML = '<li class="no-results">No categories available</li>'; return; }
  filtered.forEach((cat, idx)=>{
    const li = document.createElement('li'); li.className = 'category-item';
    li.innerHTML = `
      <div class="category-arrow"><i class="fas fa-chevron-right"></i></div>
      <div class="category-title">${cat.title}</div>
      <div class="category-count">${idx+1}</div>
    `;
    li.addEventListener('click', ()=>loadCategoryDuas(idx+1, cat.title));
    ul.appendChild(li);
  });
}

async function loadCategoryDuas(categoryId, categoryName){
  try{
    els.categoryDetails.style.display = 'block';
    els.categoriesList.style.display = 'none';
    document.querySelector('.section-title').textContent = categoryName;
    els.duaContainer.innerHTML = '<div class="loading">Loading duas...</div>';
    const res = await fetch(`duas/categories_${categoryId}/${currentLanguage}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    duasData = await res.json();
    renderDuas();
  }catch(err){
    console.error('Duas error:', err);
    els.duaContainer.innerHTML = '<div class="error">Failed to load duas.</div>';
  }
}

function renderDuas(filter=''){
  const container = els.duaContainer; container.innerHTML = '';
  let filtered = duasData;
  if(filter){
    filtered = duasData.filter(dua=>
      (dua.translation && dua.translation.toLowerCase().includes(filter.toLowerCase())) ||
      (dua.arabic && dua.arabic.includes(filter)) ||
      (dua.transliteration && dua.transliteration.toLowerCase().includes(filter.toLowerCase()))
    );
  }
  if(!filtered.length){ container.innerHTML = '<div class="no-results">No duas available</div>'; return; }
  filtered.forEach(dua=>{
    const d = document.createElement('div'); d.className = 'dua-item';
    d.innerHTML = `
      ${dua.arabic ? `<div class="dua-arabic">${dua.arabic}</div>` : ''}
      ${showTransliterations && dua.transliteration ? `<div class="dua-transliteration">${dua.transliteration}</div>` : ''}
      ${showTranslations && dua.translation ? `<div class="dua-translation">${dua.translation}</div>` : ''}
      ${dua.reference ? `<div class="dua-reference">${dua.reference}</div>` : ''}
    `;
    container.appendChild(d);
  });
}

/* ================== THEMES ================== */
const predefinedThemes = [
  {name:"Emerald",primary:"#16a34a",secondary:"#0e9f6e",bg:"#f9fafb",text:"#111827"},
  {name:"Ocean",primary:"#2563eb",secondary:"#1e3a8a",bg:"#eff6ff",text:"#0f172a"},
  {name:"Royal Purple",primary:"#7c3aed",secondary:"#4c1d95",bg:"#f5f3ff",text:"#111827"},
  {name:"Sunset",primary:"#f59e0b",secondary:"#b45309",bg:"#fffbeb",text:"#111827"},
  {name:"Ruby",primary:"#ef4444",secondary:"#b91c1c",bg:"#fef2f2",text:"#111827"},
  {name:"Teal",primary:"#14b8a6",secondary:"#0f766e",bg:"#ecfeff",text:"#0b1620"},
  {name:"Rose",primary:"#e11d48",secondary:"#881337",bg:"#fff1f2",text:"#111827"},
  {name:"Slate",primary:"#0ea5e9",secondary:"#0369a1",bg:"#f1f5f9",text:"#0f172a"},
  {name:"Indigo",primary:"#4f46e5",secondary:"#1e40af",bg:"#eef2ff",text:"#0f172a"},
  {name:"Lime",primary:"#84cc16",secondary:"#3f6212",bg:"#f7fee7",text:"#111827"},
  {name:"Amber",primary:"#f59e0b",secondary:"#92400e",bg:"#fff7ed",text:"#111827"},
  {name:"Cobalt",primary:"#1d4ed8",secondary:"#1e3a8a",bg:"#e0e7ff",text:"#0f172a"},
  {name:"Forest",primary:"#22c55e",secondary:"#065f46",bg:"#ecfdf5",text:"#0f172a"},
  {name:"Copper",primary:"#ea580c",secondary:"#9a3412",bg:"#fff7ed",text:"#111827"},
  {name:"Grape",primary:"#a855f7",secondary:"#6d28d9",bg:"#faf5ff",text:"#111827"},
  {name:"Pink",primary:"#ec4899",secondary:"#9d174d",bg:"#fdf2f8",text:"#111827"},
  {name:"Sky",primary:"#38bdf8",secondary:"#0284c7",bg:"#e0f2fe",text:"#0f172a"},
  {name:"Steel",primary:"#64748b",secondary:"#334155",bg:"#f8fafc",text:"#0f172a"},
  {name:"Mint",primary:"#2dd4bf",secondary:"#0f766e",bg:"#f0fdfa",text:"#0f172a"},
  {name:"Moss",primary:"#65a30d",secondary:"#365314",bg:"#f7fee7",text:"#111827"},
  {name:"Cranberry",primary:"#be123c",secondary:"#7f1d1d",bg:"#fff1f2",text:"#111827"},
  {name:"Denim",primary:"#1e40af",secondary:"#1e3a8a",bg:"#e2e8f0",text:"#0f172a"},
  {name:"Plum",primary:"#7e22ce",secondary:"#581c87",bg:"#faf5ff",text:"#111827"},
  {name:"Aqua",primary:"#06b6d4",secondary:"#0e7490",bg:"#e0f2fe",text:"#0f172a"},
  {name:"Charcoal",primary:"#0ea5e9",secondary:"#111827",bg:"#111827",text:"#f3f4f6"},
];

function applyTheme(t){
  document.documentElement.style.setProperty('--primary', t.primary);
  document.documentElement.style.setProperty('--secondary', t.secondary);
  document.documentElement.style.setProperty('--bg', t.bg);
  document.documentElement.style.setProperty('--text', t.text);
  // Derive neutral surfaces from bg/text for light mode; dark mode will override with body.dark
  // Border & card adjusted to bg
  const border = '#e5e7eb';
  const card = '#ffffff';
  const muted = '#6b7280';
  document.documentElement.style.setProperty('--border', border);
  document.documentElement.style.setProperty('--card', card);
  document.documentElement.style.setProperty('--muted', muted);
}

function buildThemeGrid(){
  els.themeGrid.innerHTML = '';
  predefinedThemes.forEach((t, idx)=>{
    const tile = document.createElement('div');
    tile.className = 'theme-tile';
    tile.title = t.name;
    tile.innerHTML = `
      <div class="theme-sample">
        <div class="theme-swatch" style="background:${t.primary}"></div>
        <div class="theme-swatch" style="background:${t.secondary}"></div>
        <div class="theme-swatch" style="background:${t.bg};border-left:1px solid rgba(0,0,0,.06)"></div>
      </div>
      <div class="theme-name">${t.name}</div>
    `;
    tile.addEventListener('click', ()=>{
      applyTheme(t);
      localStorage.setItem('selectedThemeIndex', String(idx));
      localStorage.removeItem('customTheme'); // clear custom if choosing predefined
    });
    els.themeGrid.appendChild(tile);
  });
}

/* ================== SETTINGS + PERSISTENCE ================== */
const STORAGE_KEYS = {
  translations: 'showTranslations',
  transliterations: 'showTransliterations',
  themeIndex: 'selectedThemeIndex',
  customTheme: 'customTheme',
  dark: 'darkMode',
  arabicFont: 'arabicFont',
  arabicFontSize: 'arabicFontSize',
  uiLang: 'uiLanguage'
};

// Load persisted settings
function loadPrefs(){
  // language
  const savedLang = localStorage.getItem(STORAGE_KEYS.uiLang);
  if(savedLang) currentLanguage = savedLang;

  // theme
  const custom = localStorage.getItem(STORAGE_KEYS.customTheme);
  const idxStr = localStorage.getItem(STORAGE_KEYS.themeIndex);
  if(custom){
    try{
      const t = JSON.parse(custom);
      applyTheme(t);
    }catch(e){}
  }else if(idxStr){
    const idx = parseInt(idxStr,10);
    if(predefinedThemes[idx]) applyTheme(predefinedThemes[idx]);
  }else{
    applyTheme(predefinedThemes[0]);
  }

  // dark
  const dark = localStorage.getItem(STORAGE_KEYS.dark);
  if(dark === '1') document.body.classList.add('dark');

  // toggles
  const tr = localStorage.getItem(STORAGE_KEYS.translations);
  const tl = localStorage.getItem(STORAGE_KEYS.transliterations);
  showTranslations = tr === null ? true : tr === '1';
  showTransliterations = tl === null ? true : tl === '1';
  els.toggleTranslations.checked = showTranslations;
  els.toggleTransliterations.checked = showTransliterations;

  // font
  const font = localStorage.getItem(STORAGE_KEYS.arabicFont);
  if(font) document.documentElement.style.setProperty('--arabic-font', `"${font}"`);
  els.arabicFontSelect.value = font || 'Amiri-BoldSlanted';

  const size = parseFloat(localStorage.getItem(STORAGE_KEYS.arabicFontSize) || '1.35');
  document.documentElement.style.setProperty('--font-arabic-size', size+'rem');
}

// Save simple helpers
function setPref(key, val){ localStorage.setItem(key, val); }

/* ================== I18N FOR SETTINGS ================== */
const i18n = {
  en:{
    settings:"Settings", back:"Back",
    showTranslations:"Show translations",
    showTransliterations:"Show transliterations",
    arabicFont:"Arabic font",
    arabicFontSize:"Arabic font size",
    themes:"Themes", chooseTheme:"Choose a theme",
    customTheme:"Custom theme",
    primary:"Primary", secondary:"Secondary", background:"Background", text:"Text",
    apply:"Apply", save:"Save as My Theme",
    developedBy:"Developed by Jibril SBI TENGEH",
    backBtn:"Back"
  },
  fr:{
    settings:"Paramètres", back:"Retour",
    showTranslations:"Afficher les traductions",
    showTransliterations:"Afficher les translittérations",
    arabicFont:"Police arabe",
    arabicFontSize:"Taille de police arabe",
    themes:"Thèmes", chooseTheme:"Choisir un thème",
    customTheme:"Thème personnalisé",
    primary:"Couleur primaire", secondary:"Secondaire", background:"Arrière-plan", text:"Texte",
    apply:"Appliquer", save:"Enregistrer comme Mon Thème",
    developedBy:"Développé par Jibril SBI TENGEH",
    backBtn:"Retour"
  },
  ru:{
    settings:"Настройки", back:"Назад",
    showTranslations:"Показывать переводы",
    showTransliterations:"Показывать транслитерации",
    arabicFont:"Арабский шрифт",
    arabicFontSize:"Размер арабского шрифта",
    themes:"Темы", chooseTheme:"Выберите тему",
    customTheme:"Пользовательская тема",
    primary:"Основной", secondary:"Второй", background:"Фон", text:"Текст",
    apply:"Применить", save:"Сохранить как Моя тема",
    developedBy:"Разработано Jibril SBI TENGEH",
    backBtn:"Назад"
  },
  zh:{
    settings:"设置", back:"返回",
    showTranslations:"显示翻译",
    showTransliterations:"显示音译",
    arabicFont:"阿拉伯字体",
    arabicFontSize:"阿拉伯字体大小",
    themes:"主题", chooseTheme:"选择主题",
    customTheme:"自定义主题",
    primary:"主色", secondary:"次色", background:"背景", text:"文字",
    apply:"应用", save:"保存为我的主题",
    developedBy:"由 Jibril SBI TENGEH 开发",
    backBtn:"返回"
  },
  ha:{
    settings:"Saituna", back:"Koma baya",
    showTranslations:"Nuna fassara",
    showTransliterations:"Nuna rubutun karin magana",
    arabicFont:"Nau'in rubutun Larabci",
    arabicFontSize:"Girman rubutun Larabci",
    themes:"Jigo", chooseTheme:"Zaɓi jigo",
    customTheme:"Jigon al'ada",
    primary:"Asali", secondary:"Na biyu", background:"Baya", text:"Rubutu",
    apply:"Aiwatar", save:"Ajiye a matsayin Jigona",
    developedBy:"An haɓaka ta Jibril SBI TENGEH",
    backBtn:"Koma baya"
  }
};

function t(key){
  const dict = i18n[currentLanguage] || i18n.en;
  return dict[key] || key;
}

function updateSettingsLabels(){
  document.getElementById('labelSettings').textContent = t('settings');
  document.getElementById('labelShowTranslations').textContent = t('showTranslations');
  document.getElementById('labelShowTransliterations').textContent = t('showTransliterations');
  document.getElementById('labelArabicFont').textContent = t('arabicFont');
  document.getElementById('labelFontSize').textContent = t('arabicFontSize');
  document.getElementById('labelOpenThemes').textContent = t('themes');
  document.getElementById('labelBackToMain').textContent = t('back');
  document.getElementById('labelChooseTheme').textContent = t('chooseTheme');
  document.getElementById('labelCustomTheme').textContent = t('customTheme');
  document.getElementById('labelPrimary').textContent = t('primary');
  document.getElementById('labelSecondary').textContent = t('secondary');
  document.getElementById('labelBg').textContent = t('background');
  document.getElementById('labelText').textContent = t('text');
  document.getElementById('labelApply').textContent = t('apply');
  document.getElementById('labelSave').textContent = t('save');
  document.getElementById('labelDevelopedBy').textContent = t('developedBy');
  document.getElementById('labelBack').textContent = t('backBtn');
}

/* ================== EVENTS ================== */
document.getElementById('languageToggle').addEventListener('click', ()=>{
  const langs = ['en','fr','ru','zh','ha'];
  const i = langs.indexOf(currentLanguage);
  currentLanguage = langs[(i+1)%langs.length];
  els.languageText.textContent = currentLanguage.toUpperCase();
  localStorage.setItem(STORAGE_KEYS.uiLang, currentLanguage);

  // keep main view intact
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  document.querySelector('.section-title').textContent = 'Categories';

  updateSettingsLabels(); // ensure settings takes chosen language
  loadCategories();
});

// Back
els.backBtn.addEventListener('click', ()=>{
  els.categoryDetails.style.display = 'none';
  els.categoriesList.style.display = 'block';
  document.querySelector('.section-title').textContent = 'Categories';
});

// Theme toggle (now toggles body.dark and icon)
els.themeToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  const icon = els.themeToggle.querySelector('i');
  const isDark = document.body.classList.contains('dark');
  icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
  setPref(STORAGE_KEYS.dark, isDark ? '1':'0');
});

// Search toggle
els.searchToggle.addEventListener('click', ()=>{
  els.searchBarContainer.style.display = els.searchBarContainer.style.display === 'none' ? 'block' : 'none';
  els.searchBar.focus();
});

// Search bar input filter
els.searchBar.addEventListener('input', ()=>{
  if(els.categoryDetails.style.display === 'block'){
    renderDuas(els.searchBar.value);
  } else {
    renderCategories(els.searchBar.value);
  }
});

/* ===== Settings open/close ===== */
els.settingsIcon.addEventListener('click', ()=>{
  els.settingsPanel.classList.add('open');
  els.settingsPanel.setAttribute('aria-hidden','false');
});
els.closeSettings.addEventListener('click', ()=>{
  els.settingsPanel.classList.remove('open');
  els.settingsPanel.setAttribute('aria-hidden','true');
});

/* ===== Main <-> Themes view ===== */
els.openThemes.addEventListener('click', ()=>{
  els.settingsMain.style.display = 'none';
  els.settingsThemes.style.display = 'block';
});
els.backToMain.addEventListener('click', ()=>{
  els.settingsThemes.style.display = 'none';
  els.settingsMain.style.display = 'block';
});

/* ===== Toggles ===== */
els.toggleTranslations.addEventListener('change', (e)=>{
  showTranslations = e.target.checked; setPref(STORAGE_KEYS.translations, showTranslations ? '1':'0'); renderDuas(els.searchBar.value || '');
});
els.toggleTransliterations.addEventListener('change', (e)=>{
  showTransliterations = e.target.checked; setPref(STORAGE_KEYS.transliterations, showTransliterations ? '1':'0'); renderDuas(els.searchBar.value || '');
});

/* ===== Arabic font select ===== */
els.arabicFontSelect.addEventListener('change', ()=>{
  const ff = els.arabicFontSelect.value;
  document.documentElement.style.setProperty('--arabic-font', `"${ff}"`);
  setPref(STORAGE_KEYS.arabicFont, ff);
});

/* ===== Font size controls ===== */
function getArabicSize(){
  const v = getComputedStyle(document.documentElement).getPropertyValue('--font-arabic-size').trim();
  return parseFloat(v);
}
function setArabicSize(val){
  const clamped = Math.max(1.0, Math.min(3.0, val)); // 1rem .. 3rem
  document.documentElement.style.setProperty('--font-arabic-size', clamped+'rem');
  setPref(STORAGE_KEYS.arabicFontSize, String(clamped));
}
els.fontSmaller.addEventListener('click', ()=> setArabicSize(getArabicSize() - 0.1));
els.fontLarger.addEventListener('click', ()=> setArabicSize(getArabicSize() + 0.1));

/* ===== Theme grid & custom theme ===== */
buildThemeGrid();

els.applyCustom.addEventListener('click', ()=>{
  const t = {
    name: 'Custom',
    primary: els.colorPrimary.value,
    secondary: els.colorSecondary.value,
    bg: els.colorBg.value,
    text: els.colorText.value
  };
  applyTheme(t);
  localStorage.setItem(STORAGE_KEYS.customTheme, JSON.stringify(t));
  localStorage.removeItem(STORAGE_KEYS.themeIndex);
});

els.saveCustom.addEventListener('click', ()=>{
  const t = {
    name: 'My Theme',
    primary: els.colorPrimary.value,
    secondary: els.colorSecondary.value,
    bg: els.colorBg.value,
    text: els.colorText.value
  };
  applyTheme(t);
  localStorage.setItem(STORAGE_KEYS.customTheme, JSON.stringify(t));
  localStorage.removeItem(STORAGE_KEYS.themeIndex);
  alert('Custom theme saved!');
});

/* ================== INIT ================== */
function init(){
  loadPrefs();
  updateSettingsLabels();

  // sync header icon with dark state
  const icon = els.themeToggle.querySelector('i');
  icon.className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';

  // init toggles checked states reflect showTranslations/showTransliterations (done in loadPrefs)

  // initial data
  loadCategories();
}
init();
</script>
</body>
</html>
